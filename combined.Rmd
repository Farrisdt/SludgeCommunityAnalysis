---
title: "DADA2_sludge_2023"
output: html_document
date: "2023-10-23"
editor_options: 
  chunk_output_type: console
---

## Acknowledgements

Thank you to our collaborator Dr. Erik Coats and our BGMP mentor Dr. Maxine Wren for technical support on this project. 
Data collection and analyses performed by the IIDS Genomics and Bioinformatics Resources Core at the University of Idaho were supported in part by NIH COBRE grant P30GM103324.

### Software Used

R 4.3.1 was used for all computations. The following packages were used:

| Package | Use |
|---------|-----|
| dplyr | general data processing |
| tibble | general data processing |
| tidyverse | general data processing | 
| DT | general data processing |
| devtools | general data processing | 
| ggplot2 | general data visualization |
| ggh4x | general data visualization |
| gridExtra | general data visualization | 
| ggpubr | general data visualization |
| viridis | colors for data visualization |
| rstatix | general data processing and visualization | 
| vegan | microbial community analysis |
| phyloseq | microbial community analysis | 
| microbiome | microbial community analysis |
| DESeq2 | normalization |
| MicEco | Euler graphs | 
| multcomp | multiple comparisons, analysis of variance | 
| ANCOMBC | differential abundance analysis | 
| DADA2 | resolving ASVs and assigning taxonomy | 
| fantaxtic | microbial abundance graphs |
| Biostrings | string container for ASVs | 
| DECIPHER | phylogenetic trees | 
| phangorn | phylogenetic trees |


## Data description

Activated sludge (AS) is a mixture of microbes that play an important part in waste water treatment (WWT). Living bacteria within AS remove polluting nutrients such as phosphorus and nitrogen before effluent is released back to the water cycle. This is an exploratory study focusing on taxonomic composition of these bacterial communities and their associated functional potential, suggesting the roles they may play in AS. In this project, we worked with data provided by Dr. Erik Coats and the Bioinformatics Core from the University of Idaho. The Coats lab has sampled AS from different waste water treatment setups: from a full-scale operational waste water treatment plant in Moscow, ID, to experimental sequencing batch reactors used for increasing PHA (polyhydroxyalkanoates) production which is a bioplastics precursor, to investigating more efficient EBPR (Enhanced Biological Phosphorus Removal) and nitrogen removal systems. 
  
The data span a range of years, and samples were collected from this variety of setups. Despite this variety, we can generally separate these systems by their intended specialized function: to remove phosphorus, to remove phosphorus and nitrogen, or to enhance PHA production.

| Variable | Description | 
| -------- | ----------- |
| System type | Scale and setup of system. Sequencing batch reactor, scale model WRRF, full scale WRRF. |
| Media type | Inflow media. Fermented dairy manure, synethetic wastewater, real wastewater. |
| Bin | Function of the system. Primarily phosphorus removal (P), primarily phosphorus + nitrogen removal (PN), primarily PHA production (PHA). |

88 individual samples of 16S rRNA gene sequenced on an individual run using multiplexing.

## Setup 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("dada2")
library("devtools")
library("phyloseq")
library("Biostrings")
library("ggplot2")
library("gridExtra")
library("dplyr")
library(tidyverse)
library(DECIPHER)
library(phangorn)
library(tibble)
library(ggh4x)
library(microbiome)
library(viridis)
library(ANCOMBC)
library(DT)
library(vegan)
library(multcomp)
library(fantaxtic)

```

```{r Set up directory}
path_R1 <- "/Users/leycufur/bioinfo/Bi624/Sludge/DADA2/R1_raw_reads" # CHANGE ME to the directory containing the fastq files after unzipping.
path_R2 <- "/Users/leycufur/bioinfo/Bi624/Sludge/DADA2/R2_raw_reads" # CHANGE ME to the directory containing the fastq files after unzipping.

working_directory <- "/Users/leycufur/bioinfo/Bi624/Sludge/DADA2/"

mylevels = c("Enrichment BSC", "Full Enrichment BSC", "Production Run BSC", "AE4","AE8", "AE12", "AE20", "BP_PX2", "BP_PX2.1", "BP_PX3", "BP_PX3.1", "BP_PX5", "BP_PX6", "FEBPR", "GEBPR", "NF", "SEBPR", "Winkler I", "Winkler J","MWWTP", "scalemodel")

```

```{r Extract sample names}
# Forward and reverse fastq filenames have format: SAMPLENAME_R1.fastq and SAMPLENAME_R2.fastq
fnFs <- sort(list.files(path_R1, pattern="_R1.fastq", full.names = TRUE))
fnRs <- sort(list.files(path_R2, pattern="_R2.fastq", full.names = TRUE))
# Extract sample names, assuming filenames have format: SAMPLENAME_XX.fastq
sample.names <- sapply(strsplit(basename(fnFs), "_"), `[`, 1)
```

## Run DADA2 to resolve ASVs

```{r Inspect read quality profiles}
# Create the plots
plot1 <- plotQualityProfile(fnFs[1:2])
plot2 <- plotQualityProfile(fnRs[1:2])

# Combine plots into a single figure
grid.arrange(plot1, plot2, nrow = 1)

```

```{r Filter and trim}
# Place filtered files in filtered/ subdirectory
filtFs <- file.path(path_R1, "filtered", paste0(sample.names, "_F_filt.fastq.gz"))
filtRs <- file.path(path_R2, "filtered", paste0(sample.names, "_R_filt.fastq.gz"))
names(filtFs) <- sample.names
names(filtRs) <- sample.names

out <- filterAndTrim(fnFs, filtFs, fnRs, filtRs, truncLen=c(260,240), 
              maxN=0, maxEE=c(3,6), truncQ=2, rm.phix=TRUE,
              compress=TRUE, multithread=TRUE) # On Windows set multithread=FALSE
head(out)
```

```{r Learn the Error Rates}

errF <- learnErrors(filtFs, multithread=TRUE)
errR <- learnErrors(filtRs, multithread=TRUE)

plotErrors(errF, nominalQ=TRUE)

```

```{r Sample Inference}
dadaFs <- dada(filtFs, err=errF, multithread=TRUE)
dadaRs <- dada(filtRs, err=errR, multithread=TRUE)
dadaFs[[1]]
```

```{r Merge paired reads}
mergers <- mergePairs(dadaFs, filtFs, dadaRs, filtRs, verbose=FALSE)
# Inspect the merger data.frame from the first sample
head(mergers[[1]])
```

```{r Construct amplicon sequence variant (ASV) table}
seqtab <- makeSequenceTable(mergers)
dim(seqtab)
# Inspect distribution of sequence lengths
table(nchar(getSequences(seqtab)))

```

```{r Remove chimeras}
seqtab.nochim <- removeBimeraDenovo(seqtab, method="consensus", multithread=TRUE, verbose=TRUE)
dim(seqtab.nochim)

sum(seqtab.nochim)/sum(seqtab)
```

```{r Track reads through the pipeline}
getN <- function(x) sum(getUniques(x))
track <- cbind(out, sapply(dadaFs, getN), sapply(dadaRs, getN), sapply(mergers, getN), rowSums(seqtab.nochim))
# If processing a single sample, remove the sapply calls: e.g. replace sapply(dadaFs, getN) with getN(dadaFs)
colnames(track) <- c("input", "filtered", "denoisedF", "denoisedR", "merged", "nonchim")
rownames(track) <- sample.names
head(track)
```

```{r Assign taxonomy}
taxa <- assignTaxonomy(seqtab.nochim, "/Users/leycufur/bioinfo/Bi624/Sludge/DADA2/silva_nr99_v138.1_train_set.fa", multithread=TRUE)

taxa2 <- addSpecies(taxa, "/Users/leycufur/bioinfo/Bi624/Sludge/DADA2/silva_species_assignment_v138_1.fa")
taxa.print <- taxa # Removing sequence rownames for display only
rownames(taxa.print) <- NULL
head(taxa.print)
``` 

```{r Transpose asv df to have ASVs as the rownames}
asv <- t(seqtab.nochim)
```

## Phyloseq

```{r Setting up a dataframe for phyloseq}

library(readxl)
metadata <- as.data.frame(read_excel("./files/Illumina_Reads_updated_3_20_24.xlsx"))
colnames(metadata) <- gsub(" ", "_", colnames(metadata)) #replacing spaces in column names with underscores

# converting the Sample_ID column to the row names
meta <- metadata %>% column_to_rownames("Sample_ID")

# adding the sample_ID back into the df
meta$Sample_ID <- rownames(meta)

```

```{r Construct phyloseq object}
# filter out asvs with counts less than 1; these might be sequencing errors # 

asv = as.data.frame(asv) %>% mutate(count = rowSums(.)) %>% dplyr::select(count, everything()) %>% filter(count > 1) %>% dplyr::select(-count)

ps <- phyloseq(otu_table(asv, taxa_are_rows = TRUE), 
               sample_data(meta), 
               tax_table(taxa))

# save a phyloseq object to reset at later points# 
backup_phyobj_all = ps
```

```{r Renaming ASVs to short names}
dna <- Biostrings::DNAStringSet(taxa_names(ps))
names(dna) <- taxa_names(ps)
ps <- merge_phyloseq(ps, dna)
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps)))

```

We can evaluate the overall alpha diversity of all the samples to get a general understanding of the spread of alpha diversity. Here are diversity values using richness, Shannon's, and Simpson's index calculations from the vegan package. 

```{r Overall alpha diversity evaluation by sample}
# prepare data into long format 
asv_df = as.data.frame(asv)
asv_names = tibble::rownames_to_column(asv_df, "ASV")
long_asv = pivot_longer(asv_names,
                        cols = 2:89,
                        names_to = "Group")
long_asv = dplyr::rename(long_asv, "name" = "ASV")
shared = long_asv

#alpha diversity functions
summary_shared = shared %>% 
  group_by(Group) %>% 
  summarize(richness = specnumber(value),
            shannon = diversity(value, index = "shannon"),
            simpson = diversity(value, index = "simpson"),
            n = sum(value))

p1 = summary_shared %>% 
  pivot_longer(cols = c(richness, shannon, simpson),
               names_to = "metric") %>% 
  ggplot(aes(x=Group, y=value)) + #plot by sample size
  geom_point()+
  geom_smooth()+
  facet_wrap(~metric, nrow = 3, scales = "free_y")

p1

ggsave("summary_sample_diversity.png", plot=p1, path = "./files/images", width = 7, height = 9, units = "in")
```

To evaluate how sampling effort affects alpha diversity, we can use random subsampling. We have a few samples (under about 10,000) that show low sampling effort may affect their results. For the most part, points follow the flat line and show that we have sufficient sampling. We should consider a cutoff of 10,000.

```{r Rarefaction: evaluate how sample size affects diversity metrics}
#code from following the tutorial available at https://riffomonas.org/code_club/2022-03-17-alpha-diversity and  https://www.youtube.com/watch?v=wq1SXGQYgCs&ab_channel=RiffomonasProject
#generate random dataframe: random subsampling 

rand <- shared %>% 
  uncount(value) %>% 
  mutate(name = sample(name)) %>% 
  dplyr::count(Group, name, name = "value")

summary_rand = rand %>% 
  group_by(Group) %>% 
  summarize(richness = specnumber(value),
            shannon = diversity(value, index = "shannon"),
            simpson = diversity(value, index = "simpson"),
            n = sum(value))

p1= summary_rand %>% 
  pivot_longer(cols = c(richness, shannon, simpson),
               names_to = "metric") %>% 
  ggplot(aes(x=n, y=value)) + #plot by sample size
  geom_point()+
  geom_smooth()+
  facet_wrap(~metric, nrow = 4, scales = "free_y")+
  ggtitle("Random sampling")+
  xlab("Sample size")

p1
#Save image
ggsave("summary_rarified_diversity.png", plot=p1, path = "./files/images", width = 7, height = 9, units = "in")
```

```{r data preprocessing}

phyobj_all = ps
phyobj_all

#Subset out other Kingdoms (one Eukaryote), mitochondria, and chloroplasts which are picked up by the Eubacteria primer

#prune to 10,000. See alpha diversity section.
samples = sample_sums(phyobj_all) > 10000
phyobj_all = prune_samples(samples, phyobj_all) 

phyobj_all = subset_taxa(phyobj_all, Kingdom == "Bacteria")
phyobj_all = subset_taxa(phyobj_all, Family != "Mitochondria")
phyobj_all = subset_taxa(phyobj_all, Order != "Chloroplast")

# List the samples that have been removed in preprocessing
new_table = otu_table(phyobj_all) %>% as.data.frame()
new_samples = colnames(new_table)
old_samples = rownames(meta)

diff = unique(old_samples[! old_samples %in% new_samples]) 
diff

phyobj_all

```

## Data preprocessing summary

We performed the following data preprocessing steps:
1a. Remove any reads not in the kingdom Bacteria
1b. Remove reads tagged as mitochondria
1c. Remove reads tagged as chloroplasts
2. Remove samples with less than 10,000 reads
3. Remove ASVs that only appear once. These are possible sequencing errors. 

```{r taxonomic resolution}
# Check for best resolution available from taxonomic assignment. #

#Before filtering
tax_df = tax_table(backup_phyobj_all) %>% as.data.frame()

sum(is.na(tax_df$Class))/length(tax_df$Class)
sum(is.na(tax_df$Order))/length(tax_df$Order)
sum(is.na(tax_df$Family))/length(tax_df$Family)
sum(is.na(tax_df$Genus))/length(tax_df$Genus)

# After filtering
tax_df = tax_table(phyobj_all) %>% as.data.frame()

sum(is.na(tax_df$Class))/length(tax_df$Class)
sum(is.na(tax_df$Order))/length(tax_df$Order)
sum(is.na(tax_df$Family))/length(tax_df$Family)
sum(is.na(tax_df$Genus))/length(tax_df$Genus)

# it looks like Family is the highest resolution possible, but we decided to go with Order for later analyses. # 
```

```{r Plot diversity measures by media type, bin type, and system type with Shannon and Simpson}

p1 = plot_richness(ps,x = "Media_Type_1", measures=c("Shannon", "Simpson"), color="Media_Type_1")
p1
ggsave(filename = "shannon_simpson_mediatype.png", plot = p1, path = "./files/images", width = 7, height = 7, units = "in")

p1 = plot_richness(ps,x = "System_Type", measures=c("Shannon", "Simpson"), color="System_Type")
p1
ggsave(filename = "shannon_simpson_systemtype.png", plot = p1, path = "./files/images", width = 7, height = 7, units = "in")

p1 = plot_richness(ps,x = "Bin", measures=c("Shannon", "Simpson"), color="Bin")
p1
ggsave(filename = "shannon_simpson_bin.png", plot = p1, path = "./files/images", width = 7, height = 7, units = "in")
```

Here we use Shannon’s index, which considers both richness and evenness and tends to outperform Simpson’s index when many rarely occurring species are present, which is suitable for our dataset.

```{r Shannon's by Bin type}
#ANOVA
richness = phyobj_all %>% estimate_richness(measures = c("Shannon", "Simpson")) %>% rownames_to_column(var="Sample.ID")
  #subset meta 
samples = unique(richness$Sample.ID)
meta_subset = meta %>% rownames_to_column(var="Sample.ID") %>% filter(Sample.ID %in% samples)

diversity = full_join(meta_subset,richness, by="Sample.ID")

diversity$Bin = diversity$Bin %>% as.character() %>% as.factor()
shannon_bin = aov(Shannon ~ Bin - 1, data = diversity)

#Check Assumptions: ANOVA
qqnorm(shannon_bin$residuals)
qqline(shannon_bin$residuals)

data.frame(
  Media = diversity$Bin,
  Residuals = shannon_bin$residuals
) %>% 
  ggplot(aes(x = Media, y = Residuals, fill = Media)) +
  geom_boxplot()+
  ggtitle("Shannon's: Bin Type")

#Pairwise Comparisons with Tukey's Method
summary(glht(shannon_bin, linfct = mcp(Bin = "Tukey")))

```

```{r Alpha Diversity Analysis: figures}
library(ggpubr)
library(rstatix)

#Use rstatix package for plotting ggplot: slightly different results for Tukey Post-Hoc but same significance
#https://github.com/kassambara/ggpubr/issues/102#issuecomment-411897608

stat.test <- shannon_bin %>% tukey_hsd()
stat.test$custom.label <- ifelse(stat.test$p.adj <= 0.05, stat.test$p.adj, "ns")

p1 = plot_richness(phyobj_all, measures = c("Shannon"), x= "Bin")+
  xlab("") + theme(axis.text.x = element_text(angle = 0, hjust = 0.5, size = 12))+
    stat_pvalue_manual(stat.test, label = "p.adj.signif", y.position = c(6, 7, 8), tip.length = 0.01)

p1
#Save plot
ggsave(filename = "shannons_bin_anova.png", plot = p1, path = "./files/images", width = 7, height = 7, units = "in")
```

## Community structure with Euler diagrams 

```{r MicEco Euler diagrams, Full Sample}
library(MicEco)
library(gridExtra)

set.seed(130) #it looks really wonky otherwise.
euler1 = ps_euler(phyobj_all, "Media_Type_1", quantities = list(type=c("percent")), fraction = 0, shape = "ellipse", weight = TRUE, relative = TRUE, fill = c("#F2D000", "#F58609", "#A01892"))
p1 = grid.arrange(grobs = list(euler1), top = "Media Type, Full Sample")

set.seed(100)
euler2 = ps_euler(phyobj_all, "System_Type", quantities = list(type=c("percent")), fraction = 0, shape = "ellipse", weight = TRUE, relative = TRUE, fill = c("#347F92", "#A6CEE3","#94DE11" ))
p2 = grid.arrange(grobs = list(euler2), top = "System Type, Full Sample")

set.seed(125)
euler3 = ps_euler(phyobj_all, "Bin", quantities = list(type=c("percent")), fraction = 0, shape = "ellipse", weight = TRUE, relative = TRUE, fill = c("#347F92", "#A6CEE3","#94DE11" ))
p3 = grid.arrange(grobs = list(euler3), top = "Bin, Full Sample")

ggsave(filename = "euler_media.png", plot = p1, path = "./files/images", width = 7, height = 4, units = "in")
ggsave(filename = "euler_system.png", plot = p2, path = "./files/images", width = 7, height = 4, units = "in")
ggsave(filename = "euler_bin.png", plot = p3, path = "./files/images", width = 7, height = 4, units = "in")
```

## Beta Diversity analysis
  
We performed variance stabilization to correct for different sequencing depth or amplification bias before performing beta diversity analysis using the DESeq2 package. 

```{r preprocessing, variance stabilization (normalization)}

# Initial code courtesy of Dr. Maxine Wren, modified to fit our analysis

library(DESeq2)

#First, we need to create a DESeq2 object. Selected experimental variable is Bin (expected function)
diagdds <- phyloseq_to_deseq2(phyobj_all, ~Bin)

#Next, we need to estimate the variance between samples
diagdds <- estimateSizeFactors(diagdds,type="poscounts")
diagdds <- estimateDispersions(diagdds) 

#Now we need to use the variance between samples to normalize the data. 
#This reduces "noise" from variation between samples that may be due to differences
#in amplification or sequencing depth.
diagvst <- getVarianceStabilizedData(diagdds) 

#Now we need to make it BACK into an ASV/OTU table and slot it back into the phyloseq.
otu_table(phyobj_all) <- otu_table(diagvst, taxa_are_rows = TRUE)
ot_df <- data.frame(otu_table(phyobj_all))
ot_df[ot_df < 0.0] <- 0.0 # why this?
ot <- otu_table(ot_df, taxa_are_rows = TRUE)
sample_names(ot) <- sample_names(phyobj_all@otu_table)
otu_table(phyobj_all) <- otu_table(ot, taxa_are_rows = TRUE)

backup_var_phyobj_all = phyobj_all
```

```{r Functionality: Faprotax}
#Prepare a properly formatted tax table for use with Faprotax.

fasv = otu_table(phyobj_all) %>% as.data.frame() %>% rownames_to_column("otu")
ftax = tax_table(phyobj_all) %>% as.data.frame()

ftax$Kingdom = paste("d", ftax$Kingdom, sep = "__")
ftax$Phylum = paste("p", ftax$Phylum, sep = "__")
ftax$Class = paste("c", ftax$Class, sep = "__")
ftax$Order = paste("o", ftax$Order, sep = "__")
ftax$Family = paste("f", ftax$Family, sep = "__")
ftax$Genus = paste("g", ftax$Genus, sep = "__")
ftax$Species = paste("s", ftax$Species, sep = "__")

ftax$Taxonomy = paste(ftax$Kingdom, ftax$Phylum, ftax$Class, ftax$Order, ftax$Family, ftax$Genus, ftax$Species, sep = ";")

tax_table = ftax %>% rownames_to_column(var = "otu") %>% dplyr::select(otu, Taxonomy)


export_tax_table = dplyr::left_join(x = as.data.frame(tax_table),
                             y = as.data.frame(fasv),
                             by = "otu") %>% dplyr::select(-otu)
 
write_tsv(export_tax_table, "silva_allgroups_taxtable_1-27-24-filt-norm.tsv")

#Run Faprotax on the command line. You will need numpy installed. 
# ./collapse_table.py -i silva_allgroups_taxtable_1-27-24-filt-norm.tsv -g FAPROTAX.txt -o silva_allgroups_taxtable_1-27-24-filt-norm_out.tsv -r silva_allgroups_taxtable_1-27-24-filt-norm_report.txt -d "Taxonomy" -v

fapro_raw = read_tsv("\\\\wsl.localhost/Ubuntu/home/ruben/bioinfo/sludge/silva_allgroups_taxtable_1-27-24-filt-norm_out.tsv", show_col_types = FALSE) %>% column_to_rownames(var = "group") %>% as.matrix()
```

## Relative Abundance

We can visualize the diversity of each individual sample, each system, and each operation type at the class level. 

```{r Relative Abundance: by Class}

# Following the phyloseq relative abundance tutorial posted here: 
# https://github.com/joey711/phyloseq/issues/1701 

#subset only Bacteria
normalized_ps = phyobj_all

#select your variable of interest here 
merged_ps_phylum_SysName = merge_samples(normalized_ps, "System_Name") 
merged_ps_phylum_Bin = merge_samples(normalized_ps, "Bin")
# merged_ps_phylum_Media = merge_samples(normalized_ps, "Media.Type.1") 
# merged_ps_phylum_SysType = merge_samples(normalized_ps, "System.Type") 

#Merge at your taxonomic rank of interest, I chose Class here.
normalized_ps_phylum1 = tax_glom(normalized_ps, "Class", NArm = TRUE)
normalized_ps_phylum2 = tax_glom(merged_ps_phylum_SysName, "Class", NArm = TRUE)
normalized_ps_phylum3 = tax_glom(merged_ps_phylum_Bin, "Class", NArm = TRUE)
# normalized_ps_phylum4 = tax_glom(merged_ps_phylum_Media, "Class", NArm = TRUE)
# normalized_ps_phylum5 = tax_glom(merged_ps_phylum_SysType, "Class", NArm = TRUE)

# Transform counts to relative abundances
normalized_ps_phylum1_relabun = transform_sample_counts(normalized_ps_phylum1, function(OTU) OTU/sum(OTU) * 100)
normalized_ps_phylum2_relabun = transform_sample_counts(normalized_ps_phylum2, function(OTU) OTU/sum(OTU) * 100)
normalized_ps_phylum3_relabun = transform_sample_counts(normalized_ps_phylum3, function(OTU) OTU/sum(OTU) * 100)
# normalized_ps_phylum4_relabun = transform_sample_counts(normalized_ps_phylum4, function(OTU) OTU/sum(OTU) * 100)
# normalized_ps_phylum5_relabun = transform_sample_counts(normalized_ps_phylum5, function(OTU) OTU/sum(OTU) * 100)

#Get the number of unique colors and select that many from iWantHue https://medialab.github.io/iwanthue/ 
tax = taxa %>% as.data.frame()
length(unique(tax_df$Class))

myColors <- c("#645fe8", "#6ebf25", "#872bb2", "#38d65f", "#a725ae", "#51c33b", "#cd6af2", "#009a1a", "#d10f9a", "#4ee084", "#f21174", "#01d6a8", "#da1932", "#01d0ba", "#c9003a", "#009946", "#ff78ee", "#247f00", "#0262e8", "#abb900", "#533fb3", "#9cd763", "#807dff", "#ffa331", "#015bb2", "#e8690c", "#1ebdff", "#cf4301", "#b091ff", "#898600", "#5f419a", "#5e7600", "#ff99f0", "#186012", "#c7006c", "#90d792", "#8f2871", "#cacb75", "#ff61a3", "#007c54", "#e24224", "#008d8d", "#ff914a", "#94bcff", "#bc7100", "#e0b1ff", "#9b7900", "#ffabef", "#325c2c", "#ffa8c9", "#5c5312", "#c492be", "#b75c00", "#7cc9af", "#962b3b", "#e5c276", "#72426a", "#f6ba8e", "#922e4f", "#6b4e00", "#ff8e98", "#854900", "#ff9182", "#7f4a34", "#ff9972", "#8e371c", "#d38f81", "#996549")

# assign specific colors to variables
# https://stackoverflow.com/questions/6919025/how-to-assign-colors-to-categorical-variables-in-ggplot2-that-have-stable-mappin


ps@tax_table
tax_df = tax %>% as.data.frame()
names(myColors) <- levels(tax_df$Class)


p1 = psmelt(normalized_ps_phylum1_relabun) 
p1 = p1 %>%
        ggplot(aes(x = Sample, y = Abundance, fill = Class)) +
        geom_bar(stat = "identity") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
        labs(y = "Relative Abundance", title = "Class Relative Abundance by Sample", x = "") +
        guides(fill = "none") + scale_fill_manual(name = "Class", values=myColors)

p2 = psmelt(normalized_ps_phylum2_relabun) 
p2$Sample = factor(p2$Sample, levels= mylevels)
p2 = p2 %>%
        ggplot(aes(x = Sample, y = Abundance, fill = Class)) +
        geom_bar(stat = "identity") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
        labs(y = "Relative Abundance", title = "Class Relative Abundance by System", x = "") +
        guides(fill="none") + scale_fill_manual(name = "Class", values=myColors)

p3 = psmelt(normalized_ps_phylum3_relabun) %>%
        ggplot(aes(x = Sample, y = Abundance, fill = Class)) +
        geom_bar(stat = "identity") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
        labs(y = "Relative Abundance", title = "Class Relative Abundance by Bin", x = "") +
        guides(fill="none") + scale_fill_manual(name = "Class", values=myColors) 


p1 
p2 
p3 + theme_bw()

#Save plots
ggsave(filename = "relabund_class_sampleid.png", plot = p1, path = working_directory)
ggsave(filename = "relabund_class_samplename.png", plot = p2, path = working_directory)
```

We can also visualize the diversity of functions present in each system. 

```{r Relative Abundance: by functionality}
#Filter out subgroupings of functionality
# fapro_filt = fapro_raw %>% t() %>% as.data.frame() %>%  dplyr::select(-c(oxygenic_photoautotrophy, methanol_oxidation, dark_sulfide_oxidation, aerobic_nitrite_oxidation, human_gut, human_pathogens_all, mammal_gut, anoxygenic_photoautotrophy, anoxygenic_photoautotrophy_S_oxidizing, photosynthetic_cyanobacteria, photoheterotrophy, thiosulfate_respiration, methanotrophy, aliphatic_non_methane_hydrocarbon_degradation, iron_respiration, aerobic_chemoheterotrophy, nitrite_respiration, photoautotrophy, sulfur_respiration, nitrate_denitrification, nitrite_denitrification, nitrous_oxide_denitrification, denitrification, nitrate_respiration, nitrogen_respiration, human_associated, aromatic_hydrocarbon_degradation, chloroplasts)) %>% t()

func_ASV = otu_table(fapro_raw, taxa_are_rows = TRUE)
SAMPLE = sample_data(meta)
phyobj_func = phyloseq(func_ASV, SAMPLE)

# plot all functions by each individual sample
merged_ps_phylum_SysName = merge_samples(phyobj_func, "System.Name") 
ps_phylum1_relabun = transform_sample_counts(merged_ps_phylum_SysName, function(OTU) OTU/sum(OTU) * 100)
myColors <- c("#645fe8", "#6ebf25", "#872bb2", "#38d65f", "#a725ae", "#51c33b", "#cd6af2", "#009a1a", "#d10f9a", "#4ee084", "#f21174", "#01d6a8", "#da1932", "#01d0ba", "#c9003a", "#009946", "#ff78ee", "#247f00", "#0262e8", "#abb900", "#533fb3", "#9cd763", "#807dff", "#ffa331", "#015bb2", "#e8690c", "#1ebdff", "#cf4301", "#b091ff", "#898600", "#5f419a", "#5e7600", "#ff99f0", "#186012", "#c7006c", "#90d792", "#8f2871", "#cacb75", "#ff61a3", "#007c54", "#e24224", "#008d8d", "#ff914a", "#94bcff", "#bc7100", "#e0b1ff", "#9b7900", "#ffabef", "#325c2c", "#ffa8c9", "#5c5312", "#c492be", "#b75c00", "#7cc9af", "#962b3b", "#e5c276", "#72426a", "#f6ba8e", "#922e4f", "#6b4e00", "#ff8e98", "#854900", "#ff9182", "#7f4a34", "#ff9972", "#8e371c", "#d38f81", "#996549","#645fe8", "#6ebf25", "#872bb2", "#38d65f", "#a725ae", "#51c33b", "#cd6af2", "#009a1a", "#d10f9a", "#4ee084", "#f21174", "#01d6a8", "#da1932", "#01d0ba", "#c9003a", "#009946", "#ff78ee", "#247f00", "#0262e8", "#abb900", "#533fb3", "#9cd763", "#807dff", "#ffa331", "#015bb2", "#e8690c", "#1ebdff", "#cf4301", "#b091ff", "#898600", "#5f419a", "#5e7600", "#ff99f0", "#186012", "#c7006c", "#90d792", "#8f2871", "#cacb75", "#ff61a3", "#007c54", "#e24224", "#008d8d", "#ff914a", "#94bcff", "#bc7100", "#e0b1ff", "#9b7900", "#ffabef", "#325c2c", "#ffa8c9", "#5c5312", "#c492be", "#b75c00", "#7cc9af", "#962b3b", "#e5c276", "#72426a", "#f6ba8e", "#922e4f", "#6b4e00", "#ff8e98", "#854900", "#ff9182", "#7f4a34", "#ff9972", "#8e371c", "#d38f81", "#996549")
p = psmelt(ps_phylum1_relabun) %>%
        ggplot(aes(x = Sample, y = Abundance, fill = OTU)) +
        geom_bar(stat = "identity") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
        labs(y = "Relative Abundance", title = "Relative abundances of tagged functions", x = "") + 
        guides(fill="none") + scale_fill_manual(name = "Class", values=myColors) 
p
ggsave(filename = "allfunctions_systemname.png", plot = p, path = working_directory)

# get top functions for bins

func_ASV = otu_table(fapro_raw, taxa_are_rows = TRUE)
phyobj_func = phyloseq(func_ASV, SAMPLE)

ps = phyobj_func

p = subset_samples(ps, Bin == "P")
p10 = names(sort(taxa_sums(p), TRUE)[1:10])
pn = subset_samples(ps, Bin == "PN")
pn10 = names(sort(taxa_sums(pn), TRUE)[1:10])
pha = subset_samples(ps, Bin == "PHA")
pha10 = r10 = names(sort(taxa_sums(pha), TRUE)[1:10])
top10 = unique(c(pha10, p10, pn10))

ps = prune_species(top10, ps)

merged_ps = merge_samples(ps, "Bin") #change what variable here

merged_ps = transform_sample_counts(merged_ps, function(OTU) OTU/sum(OTU) * 100)

#get the number of unique functions and select that many colors as above

myColors <- c("#006403", "#9d55dd", "#d5b500", "#88258e", "#a9d382", "#b0008a", "#d04b00", "#0082d2", "#ff635a", "#e99eff", "#814030", "#fcb0d3", "#9c1b5c", "firebrick", "#a0029b", "seagreen")
# tax_df = otu_table(ps) %>% as.data.frame()
# names(myColors) <- rownames(tax_df)

p1 = psmelt(merged_ps) %>% 
  ggplot(aes(x = Sample, y = Abundance, fill = OTU)) +
        geom_bar(stat = "identity") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
        labs(y = "Relative Abundance", title = "Most common functions", x = "") +
        scale_fill_manual(values=myColors) + 
        guides(fill=guide_legend(title="Function")) + theme_bw()
p1
ggsave(filename = "topfunction_bin.png", plot = p1, path = working_directory)
```
We can see exactly what taxa are the most represented in these systems. 

```{r fantaxtic top genera}
# Top taxa package for plotting nested ggplots from a phyloseq object, fantaxtic, is here: 
# https://github.com/gmteunisse/Fantaxtic

#clear any merging and changing done to phyobj_all in last chunks
# phyobj_all = backup_var_phyobj_all

library(fantaxtic)
library(magrittr)
library(ggnested)
library(gridExtra)

#Find top 10 Orders across all samples
phyobj_all = backup_var_phyobj_all
top_asv <- top_taxa(phyobj_all, n_taxa = 10, tax_level = "Order")
p = plot_nested_bar(ps_obj = top_asv$ps_obj,
                top_level = "Class",
                nested_level = "Order") +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5, color = "black"))+
  xlab("") +
  ggtitle("Top 10 Orders across all samples")
p
ggsave(filename = "topfunction_order_all.png", plot = p, path = working_directory)

# Now, top 10 by separated by Bin
phyobj_all = backup_var_phyobj_all
norm_ps = merge_samples(phyobj_all, "Bin")
top_asv <- top_taxa(norm_ps, n_taxa = 10, tax_level = "Order")
p = plot_nested_bar(ps_obj = top_asv$ps_obj,
                top_level = "Class",
                nested_level = "Order")+
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5, color = "black"))+
  xlab("")+
  ggtitle("Top 10 Orders by Bin")
p
ggsave(filename = "topfunction_order_bin.png", plot = p, path = working_directory)

# Find top Classes
top_nested <- nested_top_taxa(phyobj_all,
                              top_tax_level = "Class",
                              nested_tax_level = "Order",
                              n_top_taxa = 3, 
                              n_nested_taxa = 3)
p = plot_nested_bar(ps_obj = top_nested$ps_obj,
                top_level = "Class",
                nested_level = "Order")+
  ggtitle("Top 3 orders of top 3 classes")
p
ggsave("top_3_class_order.png", plot = p, path = working_directory)

# Find top n by Variable Type 
top_grouped <- top_taxa(phyobj_all,
                        tax_level = "Order",
                        n_taxa = 5,
                        grouping = "Bin")
top_grouped$top_taxa %>% ggplot(aes(x=Bin, y = abundance*100, fill = Order)) +
  geom_bar(stat = "identity")+
  ylab("Percent abundance")

# change levels 

vars = get_variable(phyobj_all, "System_Name")
vars = factor(vars)
levels = levels(vars)
corlevels = c(levels[1:11], "Winkler I", "Winkler J", "Production Run BSC", "Full Enrichment BSC", "SEBPR", "FEBPR", "GEBPR","NF", "MWWTP", "scalemodel")
sample_data(phyobj_all)$System.Name = levels(corlevels)


# Facet wrap 
top_nested <- nested_top_taxa(phyobj_all,
                          top_tax_level = "Class",
                          nested_tax_level = "Order",
                          n_top_taxa = 10, 
                          n_nested_taxa = 1)
p = plot_nested_bar(top_nested$ps_obj,
                top_level = "Class",
                nested_level = "Order",
                legend_title = "Class and Order") +
  facet_wrap(~Bin,
             scales = "free_x",
             ncol = 6) +
  labs(title = "Relative abundances of the top 3 orders for each of the top 3 classes") +
  theme(plot.title = element_text(hjust = 0.5, 
                                  size = 20, 
                                  face = "bold"),
        legend.key.size = unit(10, 
                               "points"))
p
ggsave("top_3_classes_top5_order_bin.png", plot = p, path = working_directory, width = 8000, height = 4000, units = "px", dpi = 380)
```

```{r Top taxa poster figure generation}

# displays poorly in R markdown but saved image has correct dimensions #

#https://github.com/gmteunisse/Fantaxtic

library(extrafont)
library(showtext)
font_add(family = "skeena", regular = "\\\\wsl.localhost/Ubuntu/home/ruben/bioinfo/sludge/skeena_d.ttf")
showtext_auto()

#Find top 10 across all samples
norm_ps = merge_samples(phyobj_all, "Bin")
norm_ps@sam_data$Bin = factor(norm_ps@sam_data$Bin, levels = c("PN", "P", "PHA"))
top_asv <- top_taxa(norm_ps, n_taxa = 10, tax_level = "Order")

# options(repr.plot.width = 4, repr.plot.height =1.5) 
p3 = plot_nested_bar(ps_obj = top_asv$ps_obj,
                     top_level = "Class",
                     nested_level = "Order",
                     palette = c(Alphaproteobacteria = "#F3722C", 
                                 Bacteroidia = "#871762",
                                 Gammaproteobacteria = "#FFBB33"),
                     merged_clr = "#919191",
                     sample_order = c("PN", "P", "PHA"),
                     legend_title = "Orders by Class") +
  labs(title = "10 most represented orders") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5, color = "black", family = "skeena", size = 40),
        axis.text.y = element_text(family = "skeena", size = 40),
        title = element_text(family = "skeena", size = 50),
        plot.background = element_rect(fill = "#F0EEE4"),
        plot.title = element_text(hjust = 0.5), 
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.title = element_text(family = "skeena", size = 40),
        legend.text = element_text(size = 40, family = "skeena")) +
  xlab("")
  


p3
ggsave("top_10_orders_bin.png", plot = p3, path = working_directory, width = 7, height = 4.5, units = "in", dpi = 300)
```

```{r ANCOMBC analysis}
# Code courtesy of Dr. Maxine Wren, modified for this data

# remove collinear variables from the metadata
filtered_meta = meta %>% dplyr::select(-c("System_Type", "Media_Type_1"))
ASV = otu_table(backup_phyobj_all)
TAX = tax_table(backup_phyobj_all)
SAMPLE = sample_data(filtered_meta)
filtered_ps = phyloseq(ASV, TAX, SAMPLE)

## remove any taxa with <10 reads in the total data set (sum of all samples <10). This is because extremely rare taxa can produce a series of false positives. 

filtered_ps = prune_taxa(taxa_sums(filtered_ps) > 10, filtered_ps) 

#check the results of filtering
otu_df = otu_table(filtered_ps) %>% as.data.frame() %>% mutate(sums = rowSums(.)) %>% dplyr::select(sums, everything())

# Continuous covariate: "Collection.Date"
# Categorical covariates: “System.Name, Bin”
# The group variable of interest: “Bin”
# Three groups: "P removal", "N and P removal", 
# The reference group: “Full scale WRRF”

# refactor the categorical variables so PHA bioreactor is the comparator
sample_data(filtered_ps)$Bin <- factor(sample_data(filtered_ps)$Bin,
                                      levels=c("PHA bioplastics reactor", 
                                               "N and P removal", 
                                               "P removal"))
# If I do the fix_formula as System.Name + Collection.Date + Bin it gives me an error about checking for collinearity or missing values in my covariates, so I am just running it with "bin" as the formula.

ancombc_out = ancombc2(filtered_ps,
                             fix_formula = "Bin",
                             tax_level = "Order",
                             group = "Bin",
                             struc_zero = TRUE,
                             neg_lb = TRUE,
                             verbose = TRUE,
                             alpha = 0.05,
                             global = TRUE,
                             pairwise = TRUE,
                             dunnet = TRUE
                             )
```

```{r taxon presence/absence}
# taxon presence/absence
tab_zero = ancombc_out$zero_ind %>% column_to_rownames(var = "taxon") #%>% mutate(sum = rowSums(.)) %>% filter(sum == 2)

res_prim = ancombc_out$res
res_global= ancombc_out$res_global %>% mutate_if(is.numeric, function(x) round(x, 5))
res_global_passed = res_global %>% filter(passed_ss == TRUE) %>% filter(diff_abn == TRUE)
diff_taxons = res_global_passed$taxon
diff_taxons
```



# Bray Curtis NMDS 

```{r variance stabilized NMDS: Bin whole sample}
set.seed(100)
#Bray-Curtis distance matrix calculation by System Type

physeq_ord <- ordinate(
 physeq = phyobj_all,
 method = "NMDS",
 formula = ~Bin,
 distance = "bray"
)
stress = as.character(round(physeq_ord$stress, digits = 3))
stresslab = paste("Stress =", stress)

p1 = plot_ordination(
 physeq = phyobj_all,
 ordination = physeq_ord,
 color = "Bin"
) +
 aes(group = Bin) +
 geom_point(aes(color = Bin), alpha = 0.95, size = 6) +
  scale_color_manual(values=c("#A6CEE3","#347F92","#94DE11"))+
 stat_ellipse(type = "t", geom = "polygon", position = "identity", alpha = .05, aes(fill = Bin)) + 
 scale_fill_manual(values=c("#A6CEE3","#347F92","#94DE11")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    panel.background = element_blank(), axis.line = element_line(colour = "black"),strip.text = element_text(colour = 'white'),text = element_text(size=12),legend.text=element_text(size=12),legend.title = element_blank())+
  annotate("text", x = 2, y = -2, label = stresslab) + 
  annotate("text", x = 2, y = -2.5, label = "Non-metric fit, R² = 0.985")

p1
ggsave("nmds_Bin.png", plot = p1, path=working_directory)

#filter out ASVs that have only 0 values
ot_df = otu_table(phyobj_all) %>% as.data.frame()

#247 -> 239
ot_df = ot_df %>% mutate(sum = rowSums(.)) %>% dplyr::select(sum, everything()) %>% filter(sum != 0) %>% dplyr::select(-sum) %>% t()
samples = rownames(ot_df)
adonis_dist = vegdist(ot_df, method = "bray") 

# adonis_mds = metaMDS(adonis_dist) %>% scores() %>% 
#   as_tibble(rownames="Group")

#subset samples needed from meta
# needed_samples = rownames(ot_df)
# parcu_adonis_meta = meta %>% rownames_to_column(var="Group") %>% filter(Group %in% needed_samples)
# 
# meta_nmds = inner_join(adonis_mds, parcu_adonis_meta, by = "Group")

# centroid_systemtype = meta_nmds %>% 
#   group_by(Bin) %>% 
#   summarize(NMDS1 = mean(NMDS1), NMDS2 = mean(NMDS2))
# 
# meta_nmds %>% 
#   ggplot(aes(x=NMDS1, y = NMDS2, color = Bin))+
#   geom_point() +
#   stat_ellipse(show.legend = FALSE) +
#   geom_point(data = centroid_systemtype, size = 2, shape = 21, color = "black", aes(fill=Bin), show.legend = FALSE)+
#  # ggtitle("Media Type, bray-curtis")+
#   scale_colour_discrete(name="Bin") +
#   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#     panel.background = element_blank(), axis.line = element_line(colour = "black"))

stressplot(physeq_ord)

submeta = meta %>% t() %>% as.data.frame %>% dplyr::select(any_of(samples)) %>% t() %>% as.data.frame()

# PERMANOVA # 
bintype = adonis2(adonis_dist ~ Bin, data = submeta, permutations = 1e4)
bintype$`Pr(>F)`[1] #p-value 

bd = betadisper(adonis_dist, submeta$Bin)
anova(bd)


```

```{r NMDS by bin, for poster}
# displays poorly in R but saves image with correct dimensions # 

physeq_ord <- ordinate(
 physeq = phyobj_all,
 method = "NMDS",
 formula = ~Bin,
 distance = "bray"
)

stress = as.character(round(physeq_ord$stress, digits = 3))
stresslab = paste("Stress =", stress)

p1 = plot_ordination(
 physeq = phyobj_all,
 ordination = physeq_ord,
 color = "Bin"
) +
 aes(group = Bin) +
 geom_point(aes(color = Bin), alpha = 0.95, size = 5) +
  scale_color_manual(values=c("#F3722C","#871762","#90B30E"))+
  scale_fill_manual(values=c("#F3722C","#871762","#90B30E")) +
  stat_ellipse(type = "t", geom = "polygon", position = "identity", alpha = .05, aes(fill = Bin)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    panel.background = element_blank(), axis.line = element_line(colour = "black"),strip.text = element_text(colour = 'white'),text = element_text(size=60, family = "skeena"),legend.text=element_text(size=60),legend.title = element_blank())+
  annotate("text", x = 4.2, y = -2, label = stresslab, size = 12, family = "skeena")+
  annotate("text", x = 3.6, y = -2.5, label = "Non-metric fit, R² = 0.985", size = 12, family = "skeena")+
  theme(plot.background = element_rect(fill = "#F0EEE4"), legend.background = element_rect(fill = "#F0EEE4"))
  

p1
ggsave("nmds_Bin.png", plot = p1, path=working_directory, height = 5, width = 7, dpi = 300)
```

Efforts were made at the beginning of the project to investigate Parcubacteria specifically. Beta diversity analysis using NMDS proved difficult due to the sparsity of Parcubacteria differences between samples. Presence-absence and abundance testing was possible, however, and revealed that PN systems and systems with real wastewater had a greater amount and variety of Parcubacteria.


=======
---
title: "DADA2_sludge_2023"
output: html_document
date: "2023-10-23"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("dada2")
library("devtools")
library("phyloseq")
library("Biostrings")
library("ggplot2")
library("gridExtra")
library("dplyr")
library(tidyverse)
library(DECIPHER)
library(phangorn)
library(tibble)
library(ggh4x)
library(microbiome)
library(viridis)
library(ANCOMBC)
library(DT)
library(vegan)
library(multcomp)
library(fantaxtic)

```


```{r Set up directory}
path_R1 <- "/Users/leycufur/bioinfo/Bi624/Sludge/DADA2/R1_raw_reads" # CHANGE ME to the directory containing the fastq files after unzipping.
path_R2 <- "/Users/leycufur/bioinfo/Bi624/Sludge/DADA2/R2_raw_reads" # CHANGE ME to the directory containing the fastq files after unzipping.

working_directory <- "/Users/leycufur/bioinfo/Bi624/Sludge/DADA2/"

mylevels = c("Enrichment BSC", "Full Enrichment BSC", "Production Run BSC", "AE4","AE8", "AE12", "AE20", "BP_PX2", "BP_PX2.1", "BP_PX3", "BP_PX3.1", "BP_PX5", "BP_PX6", "FEBPR", "GEBPR", "NF", "SEBPR", "Winkler I", "Winkler J","MWWTP", "scalemodel")

```

```{r Extract sample names}
# Forward and reverse fastq filenames have format: SAMPLENAME_R1.fastq and SAMPLENAME_R2.fastq
fnFs <- sort(list.files(path_R1, pattern="_R1.fastq", full.names = TRUE))
fnRs <- sort(list.files(path_R2, pattern="_R2.fastq", full.names = TRUE))
# Extract sample names, assuming filenames have format: SAMPLENAME_XX.fastq
sample.names <- sapply(strsplit(basename(fnFs), "_"), `[`, 1)
```

Ruben starts after the asv is made 

```{r Inspect read quality profiles}
# Create the plots
plot1 <- plotQualityProfile(fnFs[1:2])
plot2 <- plotQualityProfile(fnRs[1:2])

# Combine plots into a single figure
grid.arrange(plot1, plot2, nrow = 1)

```

```{r Filter and trim}
# Place filtered files in filtered/ subdirectory
filtFs <- file.path(path_R1, "filtered", paste0(sample.names, "_F_filt.fastq.gz"))
filtRs <- file.path(path_R2, "filtered", paste0(sample.names, "_R_filt.fastq.gz"))
names(filtFs) <- sample.names
names(filtRs) <- sample.names

out <- filterAndTrim(fnFs, filtFs, fnRs, filtRs, truncLen=c(260,240), 
              maxN=0, maxEE=c(3,6), truncQ=2, rm.phix=TRUE,
              compress=TRUE, multithread=TRUE) # On Windows set multithread=FALSE
head(out)
```

```{r Learn the Error Rates}

errF <- learnErrors(filtFs, multithread=TRUE)
errR <- learnErrors(filtRs, multithread=TRUE)

plotErrors(errF, nominalQ=TRUE)

```

```{r Sample Inference}
dadaFs <- dada(filtFs, err=errF, multithread=TRUE)
dadaRs <- dada(filtRs, err=errR, multithread=TRUE)
dadaFs[[1]]
```

```{r Merge paired reads}
mergers <- mergePairs(dadaFs, filtFs, dadaRs, filtRs, verbose=FALSE)
# Inspect the merger data.frame from the first sample
head(mergers[[1]])
```

```{r Construct amplicon sequence variant (ASV) table}
seqtab <- makeSequenceTable(mergers)
dim(seqtab)
# Inspect distribution of sequence lengths
table(nchar(getSequences(seqtab)))

```

```{r Remove chimeras}
seqtab.nochim <- removeBimeraDenovo(seqtab, method="consensus", multithread=TRUE, verbose=TRUE)
dim(seqtab.nochim)

sum(seqtab.nochim)/sum(seqtab)
```

```{r Track reads through the pipeline}
getN <- function(x) sum(getUniques(x))
track <- cbind(out, sapply(dadaFs, getN), sapply(dadaRs, getN), sapply(mergers, getN), rowSums(seqtab.nochim))
# If processing a single sample, remove the sapply calls: e.g. replace sapply(dadaFs, getN) with getN(dadaFs)
colnames(track) <- c("input", "filtered", "denoisedF", "denoisedR", "merged", "nonchim")
rownames(track) <- sample.names
head(track)
```

```{r Assign taxonomy}
taxa <- assignTaxonomy(seqtab.nochim, "/Users/leycufur/bioinfo/Bi624/Sludge/DADA2/silva_nr99_v138.1_train_set.fa", multithread=TRUE)

taxa2 <- addSpecies(taxa, "/Users/leycufur/bioinfo/Bi624/Sludge/DADA2/silva_species_assignment_v138_1.fa")
taxa.print <- taxa # Removing sequence rownames for display only
rownames(taxa.print) <- NULL
head(taxa.print)
``` 

```{r Transpose asv df to have ASVs as the rownames}
asv <- t(seqtab.nochim)
```

# Phyloseq

```{r Setting up a dataframe for phyloseq}

library(readxl)
metadata <- as.data.frame(read_excel("/Users/leycufur/bioinfo/Bi624/Sludge/Illumina_Reads_updated_1-10-24.xlsx"))
colnames(metadata) <- gsub(" ", "_", colnames(metadata)) #replacing spaces in column names with underscores

# converting the Sample_ID column to the row names
meta <- metadata %>% column_to_rownames("Sample_ID")

# adding the sample_ID back into the df
meta$Sample_ID <- rownames(meta)

```

```{r Construct phyloseq object}
asv = as.data.frame(asv) %>% mutate(count = rowSums(.)) %>% dplyr::select(count, everything()) %>% filter(count > 1) %>% dplyr::select(-count)

ps <- phyloseq(otu_table(asv, taxa_are_rows = TRUE), 
               sample_data(meta), 
               tax_table(taxa))
backup_phyobj_all = ps
```

```{r Renaming ASVs to short names}
dna <- Biostrings::DNAStringSet(taxa_names(ps))
names(dna) <- taxa_names(ps)
ps <- merge_phyloseq(ps, dna)
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps)))

```

```{r Plot richness by media type with Shannon and Simpson}
plot_richness(ps,x = "Media_Type_1", measures=c("Shannon", "Simpson"), color="Media_Type_1")

```

```{r Overall alpha diversity evaluation by sample}
# prepare data into long format 
asv_df = as.data.frame(asv)
asv_names = tibble::rownames_to_column(asv_df, "ASV")
long_asv = pivot_longer(asv_names,
                        cols = 2:89,
                        names_to = "Group")
long_asv = dplyr::rename(long_asv, "name" = "ASV")
shared = long_asv

#alpha diversity functions
summary_shared = shared %>% 
  group_by(Group) %>% 
  summarize(richness = specnumber(value),
            shannon = diversity(value, index = "shannon"),
            simpson = diversity(value, index = "simpson"),
            n = sum(value))

p1 = summary_shared %>% 
  pivot_longer(cols = c(richness, shannon, simpson),
               names_to = "metric") %>% 
  ggplot(aes(x=Group, y=value)) + #plot by sample size
  geom_point()+
  geom_smooth()+
  facet_wrap(~metric, nrow = 3, scales = "free_y")

p1

ggsave("summary_sample_diversity.png", plot=p1, path = working_directory)
```

```{r Rarefaction: evaluate how sample size affects diversity metrics}
#code from following the tutorial available at https://riffomonas.org/code_club/2022-03-17-alpha-diversity and  https://www.youtube.com/watch?v=wq1SXGQYgCs&ab_channel=RiffomonasProject
#generate random dataframe: random subsampling 

rand <- shared %>% 
  uncount(value) %>% 
  mutate(name = sample(name)) %>% 
  dplyr::count(Group, name, name = "value")

summary_rand = rand %>% 
  group_by(Group) %>% 
  summarize(richness = specnumber(value),
            shannon = diversity(value, index = "shannon"),
            simpson = diversity(value, index = "simpson"),
            n = sum(value))

p1= summary_rand %>% 
  pivot_longer(cols = c(richness, shannon, simpson),
               names_to = "metric") %>% 
  ggplot(aes(x=n, y=value)) + #plot by sample size
  geom_point()+
  geom_smooth()+
  facet_wrap(~metric, nrow = 4, scales = "free_y")+
  ggtitle("Random sampling")+
  xlab("Sample size")

p1
#Save image
ggsave("summary_rarified_diversity.png", plot=p1, path = working_directory)
```

```{r data preprocessing}

phyobj_all = ps
phyobj_all

#Subset out other Kingdoms (one Eukaryote), mitochondria, and chloroplasts which are picked up by the eubacteria primer


#prune to 10,000. See alpha diversity section.
samples = sample_sums(phyobj_all) > 10000
phyobj_all = prune_samples(samples, phyobj_all) 

phyobj_all = subset_taxa(phyobj_all, Kingdom == "Bacteria")
phyobj_all = subset_taxa(phyobj_all, Family != "Mitochondria")
phyobj_all = subset_taxa(phyobj_all, Order != "Chloroplast")


# List the samples that have been removed in preprocessing
new_table = otu_table(phyobj_all) %>% as.data.frame()
new_samples = colnames(new_table)
old_samples = rownames(meta)

diff = unique(old_samples[! old_samples %in% new_samples]) 
diff

phyobj_all

```

## Data preprocessing 

We performed the following data preprocessing steps:
1a. Remove any reads not in the kingdom Bacteria
1b. Remove reads tagged as mitochondria
1c. Remove reads tagged as chloroplasts
2. Remove samples with less than 10,000 reads
3. Remove ASVs that only appear once. These are possible sequencing errors. 

```{r taxonomic resolution}
# Check for best resolution available from taxonomic assignment. #

#Before filtering
tax_df = tax_table(backup_phyobj_all) %>% as.data.frame()

sum(is.na(tax_df$Class))/length(tax_df$Class)
sum(is.na(tax_df$Order))/length(tax_df$Order)
sum(is.na(tax_df$Family))/length(tax_df$Family)
sum(is.na(tax_df$Genus))/length(tax_df$Genus)

# After filtering
tax_df = tax_table(phyobj_all) %>% as.data.frame()

sum(is.na(tax_df$Class))/length(tax_df$Class)
sum(is.na(tax_df$Order))/length(tax_df$Order)
sum(is.na(tax_df$Family))/length(tax_df$Family)
sum(is.na(tax_df$Genus))/length(tax_df$Genus)
```

```{r Shannon's by Bin type, fig.show = "hide"}
#ANOVA
richness = phyobj_all %>% estimate_richness(measures = c("Shannon", "Simpson")) %>% rownames_to_column(var="Sample.ID")
  #subset meta 
samples = unique(richness$Sample.ID)
meta_subset = meta %>% rownames_to_column(var="Sample.ID") %>% filter(Sample.ID %in% samples)

diversity = full_join(meta_subset,richness, by="Sample.ID")

diversity$Bin = diversity$Bin %>% as.character() %>% as.factor()
shannon_bin = aov(Shannon ~ Bin - 1, data = diversity)

#Check Assumptions: ANOVA
qqnorm(shannon_bin$residuals)
qqline(shannon_bin$residuals)

data.frame(
  Media = diversity$Bin,
  Residuals = shannon_bin$residuals
) %>% 
  ggplot(aes(x = Media, y = Residuals, fill = Media)) +
  geom_boxplot()+
  ggtitle("Shannon's: Bin Type")

#Pairwise Comparisons with Tukey's Method
summary(glht(shannon_bin, linfct = mcp(Bin = "Tukey")))

```

```{r Alpha Diversity Analysis: figures}
library(ggpubr)
library(rstatix)

#Use rstatix package for plotting ggplot: slightly different results for Tukey Post-Hoc but same significance
#https://github.com/kassambara/ggpubr/issues/102#issuecomment-411897608

stat.test <- shannon_bin %>% tukey_hsd()
stat.test$custom.label <- ifelse(stat.test$p.adj <= 0.05, stat.test$p.adj, "ns")

p1 = plot_richness(phyobj_all, measures = c("Shannon"), x= "Bin")+
  xlab("") + theme(axis.text.x = element_text(angle = 0, hjust = 0.5, size = 12))+
    stat_pvalue_manual(stat.test, label = "p.adj.signif", y.position = c(6, 7, 8), tip.length = 0.01)

p1
#Save plot
ggsave(filename = "shannons_bin.png", plot = p1, path = working_directory)
```

## Community structure with Euler diagrams 
```{r MicEco Euler diagrams, Full Sample}
library(MicEco)
library(gridExtra)

set.seed(130) #it looks really wonky otherwise.
euler1 = ps_euler(phyobj_all, "Media_Type_1", quantities = list(type=c("percent")), fraction = 0, shape = "ellipse", weight = TRUE, relative = TRUE, fill = c("#F2D000", "#F58609", "#A01892"))
p1 = grid.arrange(grobs = list(euler1), top = "Media Type, Full Sample")

set.seed(100)
euler2 = ps_euler(phyobj_all, "System_Type", quantities = list(type=c("percent")), fraction = 0, shape = "ellipse", weight = TRUE, relative = TRUE, fill = c("#347F92", "#A6CEE3","#94DE11" ))
p2 = grid.arrange(grobs = list(euler2), top = "System Type, Full Sample")

set.seed(123)
euler3 = ps_euler(phyobj_all, "Bin", quantities = list(type=c("percent")), fraction = 0, shape = "ellipse", weight = TRUE, relative = TRUE, fill = c("#347F92", "#A6CEE3","#94DE11" ))
p3 = grid.arrange(grobs = list(euler3), top = "Bin, Full Sample")

ggsave(filename = "euler_media.png", plot = p1, path = working_directory)
ggsave(filename = "euler_system.png", plot = p2, path = working_directory)
ggsave(filename = "euler_bin.png", plot = p3, path = working_directory)
```

## Beta Diversity analysis
  
We performed variance stabilization to correct for different sequencing depth or amplification bias before performing beta diversity analysis using the DESeq2 package. 

```{r preprocessing, variance stabilization (normalization)}

# Initial code courtesy of Dr. Maxine Wren, modified to fit our analysis

library(DESeq2)

#First, we need to create a DESeq2 object. Selected experimental variable is Bin (expected function)
diagdds <- phyloseq_to_deseq2(phyobj_all, ~Bin)

#Next, we need to estimate the variance between samples
diagdds <- estimateSizeFactors(diagdds,type="poscounts")
diagdds <- estimateDispersions(diagdds) 

#Now we need to use the variance between samples to normalize the data. 
#This reduces "noise" from variation between samples that may be due to differences
#in amplification or sequencing depth.
diagvst <- getVarianceStabilizedData(diagdds) 

#Now we need to make it BACK into an ASV/OTU table and slot it back into the phyloseq.
otu_table(phyobj_all) <- otu_table(diagvst, taxa_are_rows = TRUE)
ot_df <- data.frame(otu_table(phyobj_all))
ot_df[ot_df < 0.0] <- 0.0 # why this?
ot <- otu_table(ot_df, taxa_are_rows = TRUE)
sample_names(ot) <- sample_names(phyobj_all@otu_table)
otu_table(phyobj_all) <- otu_table(ot, taxa_are_rows = TRUE)

backup_var_phyobj_all = phyobj_all
```

```{r Functionality: Faprotax}
#Prepare a properly formatted tax table for use with Faprotax.

fasv = otu_table(phyobj_all) %>% as.data.frame() %>% rownames_to_column("otu")
ftax = tax_table(phyobj_all) %>% as.data.frame()

ftax$Kingdom = paste("d", ftax$Kingdom, sep = "__")
ftax$Phylum = paste("p", ftax$Phylum, sep = "__")
ftax$Class = paste("c", ftax$Class, sep = "__")
ftax$Order = paste("o", ftax$Order, sep = "__")
ftax$Family = paste("f", ftax$Family, sep = "__")
ftax$Genus = paste("g", ftax$Genus, sep = "__")
ftax$Species = paste("s", ftax$Species, sep = "__")

ftax$Taxonomy = paste(ftax$Kingdom, ftax$Phylum, ftax$Class, ftax$Order, ftax$Family, ftax$Genus, ftax$Species, sep = ";")

tax_table = ftax %>% rownames_to_column(var = "otu") %>% dplyr::select(otu, Taxonomy)


export_tax_table = dplyr::left_join(x = as.data.frame(tax_table),
                             y = as.data.frame(fasv),
                             by = "otu") %>% dplyr::select(-otu)
 
write_tsv(export_tax_table, "silva_allgroups_taxtable_1-27-24-filt-norm.tsv")

#Run Faprotax on the command line. You will need numpy installed. 
# ./collapse_table.py -i silva_allgroups_taxtable_1-27-24-filt-norm.tsv -g FAPROTAX.txt -o silva_allgroups_taxtable_1-27-24-filt-norm_out.tsv -r silva_allgroups_taxtable_1-27-24-filt-norm_report.txt -d "Taxonomy" -v

fapro_raw = read_tsv("\\\\wsl.localhost/Ubuntu/home/ruben/bioinfo/sludge/silva_allgroups_taxtable_1-27-24-filt-norm_out.tsv", show_col_types = FALSE) %>% column_to_rownames(var = "group") %>% as.matrix()
```

## Relative Abundance

We can visualize the diversity of each individual sample, each system, and each operation type at the class level. 

```{r Relative Abundance: by Class}

# Following the phyloseq relative abundance tutorial posted here: 
# https://github.com/joey711/phyloseq/issues/1701 

#subset only Bacteria
normalized_ps = phyobj_all

#select your variable of interest here 
merged_ps_phylum_SysName = merge_samples(normalized_ps, "System_Name") 
merged_ps_phylum_Bin = merge_samples(normalized_ps, "Bin")
# merged_ps_phylum_Media = merge_samples(normalized_ps, "Media.Type.1") 
# merged_ps_phylum_SysType = merge_samples(normalized_ps, "System.Type") 

#Merge at your taxonomic rank of interest, I chose Class here.
normalized_ps_phylum1 = tax_glom(normalized_ps, "Class", NArm = TRUE)
normalized_ps_phylum2 = tax_glom(merged_ps_phylum_SysName, "Class", NArm = TRUE)
normalized_ps_phylum3 = tax_glom(merged_ps_phylum_Bin, "Class", NArm = TRUE)
# normalized_ps_phylum4 = tax_glom(merged_ps_phylum_Media, "Class", NArm = TRUE)
# normalized_ps_phylum5 = tax_glom(merged_ps_phylum_SysType, "Class", NArm = TRUE)

# Transform counts to relative abundances
normalized_ps_phylum1_relabun = transform_sample_counts(normalized_ps_phylum1, function(OTU) OTU/sum(OTU) * 100)
normalized_ps_phylum2_relabun = transform_sample_counts(normalized_ps_phylum2, function(OTU) OTU/sum(OTU) * 100)
normalized_ps_phylum3_relabun = transform_sample_counts(normalized_ps_phylum3, function(OTU) OTU/sum(OTU) * 100)
# normalized_ps_phylum4_relabun = transform_sample_counts(normalized_ps_phylum4, function(OTU) OTU/sum(OTU) * 100)
# normalized_ps_phylum5_relabun = transform_sample_counts(normalized_ps_phylum5, function(OTU) OTU/sum(OTU) * 100)

#Get the number of unique colors and select that many from iWantHue https://medialab.github.io/iwanthue/ 
tax = taxa %>% as.data.frame()
length(unique(tax_df$Class))

myColors <- c("#645fe8", "#6ebf25", "#872bb2", "#38d65f", "#a725ae", "#51c33b", "#cd6af2", "#009a1a", "#d10f9a", "#4ee084", "#f21174", "#01d6a8", "#da1932", "#01d0ba", "#c9003a", "#009946", "#ff78ee", "#247f00", "#0262e8", "#abb900", "#533fb3", "#9cd763", "#807dff", "#ffa331", "#015bb2", "#e8690c", "#1ebdff", "#cf4301", "#b091ff", "#898600", "#5f419a", "#5e7600", "#ff99f0", "#186012", "#c7006c", "#90d792", "#8f2871", "#cacb75", "#ff61a3", "#007c54", "#e24224", "#008d8d", "#ff914a", "#94bcff", "#bc7100", "#e0b1ff", "#9b7900", "#ffabef", "#325c2c", "#ffa8c9", "#5c5312", "#c492be", "#b75c00", "#7cc9af", "#962b3b", "#e5c276", "#72426a", "#f6ba8e", "#922e4f", "#6b4e00", "#ff8e98", "#854900", "#ff9182", "#7f4a34", "#ff9972", "#8e371c", "#d38f81", "#996549")

# assign specific colors to variables
# https://stackoverflow.com/questions/6919025/how-to-assign-colors-to-categorical-variables-in-ggplot2-that-have-stable-mappin


ps@tax_table
tax_df = tax %>% as.data.frame()
names(myColors) <- levels(tax_df$Class)


p1 = psmelt(normalized_ps_phylum1_relabun) 
p1 = p1 %>%
        ggplot(aes(x = Sample, y = Abundance, fill = Class)) +
        geom_bar(stat = "identity") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
        labs(y = "Relative Abundance", title = "Class Relative Abundance by Sample", x = "") +
        guides(fill = "none") + scale_fill_manual(name = "Class", values=myColors)

p2 = psmelt(normalized_ps_phylum2_relabun) 
p2$Sample = factor(p2$Sample, levels= mylevels)
p2 = p2 %>%
        ggplot(aes(x = Sample, y = Abundance, fill = Class)) +
        geom_bar(stat = "identity") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
        labs(y = "Relative Abundance", title = "Class Relative Abundance by System", x = "") +
        guides(fill="none") + scale_fill_manual(name = "Class", values=myColors)

p3 = psmelt(normalized_ps_phylum3_relabun) %>%
        ggplot(aes(x = Sample, y = Abundance, fill = Class)) +
        geom_bar(stat = "identity") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
        labs(y = "Relative Abundance", title = "Class Relative Abundance by Bin", x = "") +
        guides(fill="none") + scale_fill_manual(name = "Class", values=myColors) 


p1 
p2 
p3 + theme_bw()

#Save plots
ggsave(filename = "relabund_class_sampleid.png", plot = p1, path = working_directory)
ggsave(filename = "relabund_class_samplename.png", plot = p2, path = working_directory)
```

We can also visualize the diversity of functions present in each system. 

```{r Relative Abundance: by functionality}
#Filter out subgroupings of functionality
# fapro_filt = fapro_raw %>% t() %>% as.data.frame() %>%  dplyr::select(-c(oxygenic_photoautotrophy, methanol_oxidation, dark_sulfide_oxidation, aerobic_nitrite_oxidation, human_gut, human_pathogens_all, mammal_gut, anoxygenic_photoautotrophy, anoxygenic_photoautotrophy_S_oxidizing, photosynthetic_cyanobacteria, photoheterotrophy, thiosulfate_respiration, methanotrophy, aliphatic_non_methane_hydrocarbon_degradation, iron_respiration, aerobic_chemoheterotrophy, nitrite_respiration, photoautotrophy, sulfur_respiration, nitrate_denitrification, nitrite_denitrification, nitrous_oxide_denitrification, denitrification, nitrate_respiration, nitrogen_respiration, human_associated, aromatic_hydrocarbon_degradation, chloroplasts)) %>% t()

func_ASV = otu_table(fapro_raw, taxa_are_rows = TRUE)
SAMPLE = sample_data(meta)
phyobj_func = phyloseq(func_ASV, SAMPLE)

# plot all functions by each individual sample
merged_ps_phylum_SysName = merge_samples(phyobj_func, "System.Name") 
ps_phylum1_relabun = transform_sample_counts(merged_ps_phylum_SysName, function(OTU) OTU/sum(OTU) * 100)
myColors <- c("#645fe8", "#6ebf25", "#872bb2", "#38d65f", "#a725ae", "#51c33b", "#cd6af2", "#009a1a", "#d10f9a", "#4ee084", "#f21174", "#01d6a8", "#da1932", "#01d0ba", "#c9003a", "#009946", "#ff78ee", "#247f00", "#0262e8", "#abb900", "#533fb3", "#9cd763", "#807dff", "#ffa331", "#015bb2", "#e8690c", "#1ebdff", "#cf4301", "#b091ff", "#898600", "#5f419a", "#5e7600", "#ff99f0", "#186012", "#c7006c", "#90d792", "#8f2871", "#cacb75", "#ff61a3", "#007c54", "#e24224", "#008d8d", "#ff914a", "#94bcff", "#bc7100", "#e0b1ff", "#9b7900", "#ffabef", "#325c2c", "#ffa8c9", "#5c5312", "#c492be", "#b75c00", "#7cc9af", "#962b3b", "#e5c276", "#72426a", "#f6ba8e", "#922e4f", "#6b4e00", "#ff8e98", "#854900", "#ff9182", "#7f4a34", "#ff9972", "#8e371c", "#d38f81", "#996549","#645fe8", "#6ebf25", "#872bb2", "#38d65f", "#a725ae", "#51c33b", "#cd6af2", "#009a1a", "#d10f9a", "#4ee084", "#f21174", "#01d6a8", "#da1932", "#01d0ba", "#c9003a", "#009946", "#ff78ee", "#247f00", "#0262e8", "#abb900", "#533fb3", "#9cd763", "#807dff", "#ffa331", "#015bb2", "#e8690c", "#1ebdff", "#cf4301", "#b091ff", "#898600", "#5f419a", "#5e7600", "#ff99f0", "#186012", "#c7006c", "#90d792", "#8f2871", "#cacb75", "#ff61a3", "#007c54", "#e24224", "#008d8d", "#ff914a", "#94bcff", "#bc7100", "#e0b1ff", "#9b7900", "#ffabef", "#325c2c", "#ffa8c9", "#5c5312", "#c492be", "#b75c00", "#7cc9af", "#962b3b", "#e5c276", "#72426a", "#f6ba8e", "#922e4f", "#6b4e00", "#ff8e98", "#854900", "#ff9182", "#7f4a34", "#ff9972", "#8e371c", "#d38f81", "#996549")
p = psmelt(ps_phylum1_relabun) %>%
        ggplot(aes(x = Sample, y = Abundance, fill = OTU)) +
        geom_bar(stat = "identity") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
        labs(y = "Relative Abundance", title = "Relative abundances of tagged functions", x = "") + 
        guides(fill="none") + scale_fill_manual(name = "Class", values=myColors) 
p
ggsave(filename = "allfunctions_systemname.png", plot = p, path = working_directory)

# get top functions for bins

func_ASV = otu_table(fapro_raw, taxa_are_rows = TRUE)
phyobj_func = phyloseq(func_ASV, SAMPLE)

ps = phyobj_func

p = subset_samples(ps, Bin == "P")
p10 = names(sort(taxa_sums(p), TRUE)[1:10])
pn = subset_samples(ps, Bin == "PN")
pn10 = names(sort(taxa_sums(pn), TRUE)[1:10])
pha = subset_samples(ps, Bin == "PHA")
pha10 = r10 = names(sort(taxa_sums(pha), TRUE)[1:10])
top10 = unique(c(pha10, p10, pn10))

ps = prune_species(top10, ps)

merged_ps = merge_samples(ps, "Bin") #change what variable here

merged_ps = transform_sample_counts(merged_ps, function(OTU) OTU/sum(OTU) * 100)

#get the number of unique functions and select that many colors as above

myColors <- c("#006403", "#9d55dd", "#d5b500", "#88258e", "#a9d382", "#b0008a", "#d04b00", "#0082d2", "#ff635a", "#e99eff", "#814030", "#fcb0d3", "#9c1b5c", "firebrick", "#a0029b", "seagreen")
# tax_df = otu_table(ps) %>% as.data.frame()
# names(myColors) <- rownames(tax_df)

p1 = psmelt(merged_ps) %>% 
  ggplot(aes(x = Sample, y = Abundance, fill = OTU)) +
        geom_bar(stat = "identity") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
        labs(y = "Relative Abundance", title = "Most common functions", x = "") +
        scale_fill_manual(values=myColors) + 
        guides(fill=guide_legend(title="Function")) + theme_bw()
p1
ggsave(filename = "topfunction_bin.png", plot = p1, path = working_directory)
```
We can see exactly what taxa are the most represented in these systems. 

```{r fantaxtic top genera}
# Top taxa package for plotting nested ggplots from a phyloseq object, fantaxtic, is here: 
# https://github.com/gmteunisse/Fantaxtic

#clear any merging and changing done to phyobj_all in last chunks
# phyobj_all = backup_var_phyobj_all

library(fantaxtic)
library(magrittr)
library(ggnested)
library(gridExtra)

#Find top 10 Orders across all samples
phyobj_all = backup_var_phyobj_all
top_asv <- top_taxa(phyobj_all, n_taxa = 10, tax_level = "Order")
p = plot_nested_bar(ps_obj = top_asv$ps_obj,
                top_level = "Class",
                nested_level = "Order") +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5, color = "black"))+
  xlab("") +
  ggtitle("Top 10 Orders across all samples")
p
ggsave(filename = "topfunction_order_all.png", plot = p, path = working_directory)

# Now, top 10 by separated by Bin
phyobj_all = backup_var_phyobj_all
norm_ps = merge_samples(phyobj_all, "Bin")
top_asv <- top_taxa(norm_ps, n_taxa = 10, tax_level = "Order")
p = plot_nested_bar(ps_obj = top_asv$ps_obj,
                top_level = "Class",
                nested_level = "Order")+
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5, color = "black"))+
  xlab("")+
  ggtitle("Top 10 Orders by Bin")
p
ggsave(filename = "topfunction_order_bin.png", plot = p, path = working_directory)

# Find top Classes
top_nested <- nested_top_taxa(phyobj_all,
                              top_tax_level = "Class",
                              nested_tax_level = "Order",
                              n_top_taxa = 3, 
                              n_nested_taxa = 3)
p = plot_nested_bar(ps_obj = top_nested$ps_obj,
                top_level = "Class",
                nested_level = "Order")+
  ggtitle("Top 3 orders of top 3 classes")
p
ggsave("top_3_class_order.png", plot = p, path = working_directory)

# Find top n by Variable Type 
top_grouped <- top_taxa(phyobj_all,
                        tax_level = "Order",
                        n_taxa = 5,
                        grouping = "Bin")
top_grouped$top_taxa %>% ggplot(aes(x=Bin, y = abundance*100, fill = Order)) +
  geom_bar(stat = "identity")+
  ylab("Percent abundance")

# change levels 

vars = get_variable(phyobj_all, "System_Name")
vars = factor(vars)
levels = levels(vars)
corlevels = c(levels[1:11], "Winkler I", "Winkler J", "Production Run BSC", "Full Enrichment BSC", "SEBPR", "FEBPR", "GEBPR","NF", "MWWTP", "scalemodel")
sample_data(phyobj_all)$System.Name = levels(corlevels)


# Facet wrap 
top_nested <- nested_top_taxa(phyobj_all,
                          top_tax_level = "Class",
                          nested_tax_level = "Order",
                          n_top_taxa = 10, 
                          n_nested_taxa = 1)
p = plot_nested_bar(top_nested$ps_obj,
                top_level = "Class",
                nested_level = "Order",
                legend_title = "Class and Order") +
  facet_wrap(~Bin,
             scales = "free_x",
             ncol = 6) +
  labs(title = "Relative abundances of the top 3 orders for each of the top 3 classes") +
  theme(plot.title = element_text(hjust = 0.5, 
                                  size = 20, 
                                  face = "bold"),
        legend.key.size = unit(10, 
                               "points"))
p
ggsave("top_3_classes_top5_order_bin.png", plot = p, path = working_directory, width = 8000, height = 4000, units = "px", dpi = 380)
```

```{r Top taxa poster figure generation}

# displays poorly in R markdown but saved image has correct dimensions #

#https://github.com/gmteunisse/Fantaxtic

library(extrafont)
library(showtext)
font_add(family = "skeena", regular = "\\\\wsl.localhost/Ubuntu/home/ruben/bioinfo/sludge/skeena_d.ttf")
showtext_auto()

#Find top 10 across all samples
norm_ps = merge_samples(phyobj_all, "Bin")
norm_ps@sam_data$Bin = factor(norm_ps@sam_data$Bin, levels = c("PN", "P", "PHA"))
top_asv <- top_taxa(norm_ps, n_taxa = 10, tax_level = "Order")

# options(repr.plot.width = 4, repr.plot.height =1.5) 
p3 = plot_nested_bar(ps_obj = top_asv$ps_obj,
                     top_level = "Class",
                     nested_level = "Order",
                     palette = c(Alphaproteobacteria = "#F3722C", 
                                 Bacteroidia = "#871762",
                                 Gammaproteobacteria = "#FFBB33"),
                     merged_clr = "#919191",
                     sample_order = c("PN", "P", "PHA"),
                     legend_title = "Orders by Class") +
  labs(title = "10 most represented orders") +
  theme_light() +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5, color = "black", family = "skeena", size = 40),
        axis.text.y = element_text(family = "skeena", size = 40),
        title = element_text(family = "skeena", size = 50),
        plot.background = element_rect(fill = "#F0EEE4"),
        plot.title = element_text(hjust = 0.5), 
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.title = element_text(family = "skeena", size = 40),
        legend.text = element_text(size = 40, family = "skeena")) +
  xlab("")
  


p3
ggsave("top_10_orders_bin.png", plot = p3, path = working_directory, width = 7, height = 4.5, units = "in", dpi = 300)
```

```{r ANCOMBC analysis}
# Code courtesy of Dr. Maxine Wren, modified for this data

# remove collinear variables from the metadata
filtered_meta = meta %>% dplyr::select(-c("System_Type", "Media_Type_1"))
ASV = otu_table(backup_phyobj_all)
TAX = tax_table(backup_phyobj_all)
SAMPLE = sample_data(filtered_meta)
filtered_ps = phyloseq(ASV, TAX, SAMPLE)

## remove any taxa with <10 reads in the total data set (sum of all samples <10). This is because extremely rare taxa can produce a series of false positives. 

filtered_ps = prune_taxa(taxa_sums(filtered_ps) > 10, filtered_ps) 

#check the results of filtering
otu_df = otu_table(filtered_ps) %>% as.data.frame() %>% mutate(sums = rowSums(.)) %>% dplyr::select(sums, everything())

# Continuous covariate: "Collection.Date"
# Categorical covariates: “System.Name, Bin”
# The group variable of interest: “Bin”
# Three groups: "P removal", "N and P removal", 
# The reference group: “Full scale WRRF”

# refactor the categorical variables so PHA bioreactor is the comparator
sample_data(filtered_ps)$Bin <- factor(sample_data(filtered_ps)$Bin,
                                      levels=c("PHA bioplastics reactor", 
                                               "N and P removal", 
                                               "P removal"))
# If I do the fix_formula as System.Name + Collection.Date + Bin it gives me an error about checking for collinearity or missing values in my covariates, so I am just running it with "bin" as the formula.

ancombc_out = ancombc2(filtered_ps,
                             fix_formula = "Bin",
                             tax_level = "Order",
                             group = "Bin",
                             struc_zero = TRUE,
                             neg_lb = TRUE,
                             verbose = TRUE,
                             alpha = 0.05,
                             global = TRUE,
                             pairwise = TRUE,
                             dunnet = TRUE
                             )
```

```{r taxon presence/absence}
# taxon presence/absence
tab_zero = ancombc_out$zero_ind %>% column_to_rownames(var = "taxon") #%>% mutate(sum = rowSums(.)) %>% filter(sum == 2)

res_prim = ancombc_out$res
res_global= ancombc_out$res_global %>% mutate_if(is.numeric, function(x) round(x, 5))
res_global_passed = res_global %>% filter(passed_ss == TRUE) %>% filter(diff_abn == TRUE)
diff_taxons = res_global_passed$taxon
diff_taxons
```



# Bray Curtis NMDS 

```{r variance stabilized NMDS: Bin whole sample}
set.seed(100)
#Bray-Curtis distance matrix calculation by System Type

physeq_ord <- ordinate(
 physeq = phyobj_all,
 method = "NMDS",
 formula = ~Bin,
 distance = "bray"
)
stress = as.character(round(physeq_ord$stress, digits = 3))
stresslab = paste("Stress =", stress)

p1 = plot_ordination(
 physeq = phyobj_all,
 ordination = physeq_ord,
 color = "Bin"
) +
 aes(group = Bin) +
 geom_point(aes(color = Bin), alpha = 0.95, size = 6) +
  scale_color_manual(values=c("#A6CEE3","#347F92","#94DE11"))+
 stat_ellipse(type = "t", geom = "polygon", position = "identity", alpha = .05, aes(fill = Bin)) + 
 scale_fill_manual(values=c("#A6CEE3","#347F92","#94DE11")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    panel.background = element_blank(), axis.line = element_line(colour = "black"),strip.text = element_text(colour = 'white'),text = element_text(size=12),legend.text=element_text(size=12),legend.title = element_blank())+
  annotate("text", x = 2, y = -2, label = stresslab) + 
  annotate("text", x = 2, y = -2.5, label = "Non-metric fit, R² = 0.985")

p1
ggsave("nmds_Bin.png", plot = p1, path=working_directory)

#filter out ASVs that have only 0 values
ot_df = otu_table(phyobj_all) %>% as.data.frame()

#247 -> 239
ot_df = ot_df %>% mutate(sum = rowSums(.)) %>% dplyr::select(sum, everything()) %>% filter(sum != 0) %>% dplyr::select(-sum) %>% t()
samples = rownames(ot_df)
adonis_dist = vegdist(ot_df, method = "bray") 

# adonis_mds = metaMDS(adonis_dist) %>% scores() %>% 
#   as_tibble(rownames="Group")

#subset samples needed from meta
# needed_samples = rownames(ot_df)
# parcu_adonis_meta = meta %>% rownames_to_column(var="Group") %>% filter(Group %in% needed_samples)
# 
# meta_nmds = inner_join(adonis_mds, parcu_adonis_meta, by = "Group")

# centroid_systemtype = meta_nmds %>% 
#   group_by(Bin) %>% 
#   summarize(NMDS1 = mean(NMDS1), NMDS2 = mean(NMDS2))
# 
# meta_nmds %>% 
#   ggplot(aes(x=NMDS1, y = NMDS2, color = Bin))+
#   geom_point() +
#   stat_ellipse(show.legend = FALSE) +
#   geom_point(data = centroid_systemtype, size = 2, shape = 21, color = "black", aes(fill=Bin), show.legend = FALSE)+
#  # ggtitle("Media Type, bray-curtis")+
#   scale_colour_discrete(name="Bin") +
#   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#     panel.background = element_blank(), axis.line = element_line(colour = "black"))

stressplot(physeq_ord)

submeta = meta %>% t() %>% as.data.frame %>% dplyr::select(any_of(samples)) %>% t() %>% as.data.frame()

# PERMANOVA # 
bintype = adonis2(adonis_dist ~ Bin, data = submeta, permutations = 1e4)
bintype$`Pr(>F)`[1] #p-value 

bd = betadisper(adonis_dist, submeta$Bin)
anova(bd)


```

```{r NMDS by bin, for poster}
# displays poorly in R but saves image with correct dimensions # 

physeq_ord <- ordinate(
 physeq = phyobj_all,
 method = "NMDS",
 formula = ~Bin,
 distance = "bray"
)

stress = as.character(round(physeq_ord$stress, digits = 3))
stresslab = paste("Stress =", stress)

p1 = plot_ordination(
 physeq = phyobj_all,
 ordination = physeq_ord,
 color = "Bin"
) +
 aes(group = Bin) +
 geom_point(aes(color = Bin), alpha = 0.95, size = 5) +
  scale_color_manual(values=c("#F3722C","#871762","#90B30E"))+
  scale_fill_manual(values=c("#F3722C","#871762","#90B30E")) +
  stat_ellipse(type = "t", geom = "polygon", position = "identity", alpha = .05, aes(fill = Bin)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    panel.background = element_blank(), axis.line = element_line(colour = "black"),strip.text = element_text(colour = 'white'),text = element_text(size=60, family = "skeena"),legend.text=element_text(size=60),legend.title = element_blank())+
  annotate("text", x = 4.2, y = -2, label = stresslab, size = 12, family = "skeena")+
  annotate("text", x = 3.6, y = -2.5, label = "Non-metric fit, R² = 0.985", size = 12, family = "skeena")+
  theme(plot.background = element_rect(fill = "#F0EEE4"), legend.background = element_rect(fill = "#F0EEE4"))
  

p1
ggsave("nmds_Bin.png", plot = p1, path=working_directory, height = 5, width = 7, dpi = 300)
```

Efforts were made at the beginning of the project to investigate Parcubacteria specifically. Beta diversity analysis using NMDS proved difficult due to the sparsity of Parcubacteria differences between samples. Presence-absence and abundance testing was possible, however, and revealed that PN systems and systems with real wastewater had a greater amount and variety of Parcubacteria.


```{r Read in asv / tax files} 
#Files are generated by FAPROTAX

#The asv file can be formatted either by frequency or by counts.
#asv <- read_tsv("C:/Users/farri/Coding/Sludge/asv_table_leyla_1-9-23.tsv")
   #fapro_raw = read_tsv("C:/Users/farri/Coding/Sludge/silva_allgroups_taxtable_1-25-24-filtered_out.tsv")
#Taxonomy assignment file
#tax <- read_csv("C:/Users/farri/Coding/Sludge/taxa_silva_dada2_20240110.csv")
report <- read_tsv("C:/Users/farri/Coding/Sludge/Funtional_Taxonomy_Report.txt")

#fix under counting NA in data file
total_na = report %>% filter(is.na(report$order))
report= mutate(report, order_total=replace(order_total, is.na(order), sum(total_na$count)))
metapath = meta#"C:/Users/farri/Coding/Sludge/Sludge_Metadata_1_10_24.xlsx"

```

```{r Read in faprotax and format into different objects}
#This section hard codes in a lot of row and column numbers. If there are changes to the dataset this will break or give incorrect information, be sure to edit as needed.
fapro = fapro_raw
fapro$group_total <- rowSums(fapro[,2:89])
faproOver0 = filter(fapro, as.numeric(group_total)>= 1) #only keeping functions seen at least once
faproOver0[91]=faproOver0[1]
fapro300 = filter(fapro, as.numeric(group_total)>= 300) #only keeping functions seen over 300 times
fapro5000 = filter(fapro, as.numeric(group_total)>= 5000) #only keeping functions seen over 5000 times

# These functions are known to be associated with waste water treatment
wwt_fapro = filter(fapro, fapro$group %in% c("aerobic_chemoheterotrophy", "chemoheterotrophy", "denitrification", "nitrate_denitrification", "nitrate_reduction",
"nitrate_respiration",
"nitrite_denitrification",
"nitrite_respiration", "nitrogen_respiration",
"nitrous_oxide_denitrification", "Sample_ID"))

fapro_Long = transpose(fapro_raw)
rownames(fapro_Long) = colnames(fapro_raw)
colnames(fapro_Long) <- fapro_raw$group
fapro_Long = fapro_Long[-1,]
fapro_Long[, 1:92] <- sapply(fapro_Long[, 1:92], as.numeric)
fapro_Long$group_total <- rowSums(fapro_Long[,1:92]) #total number of functions per sample
fapro_Long = tibble::rownames_to_column(fapro_Long, "Sample_ID")

meta = read_excel(metapath)
names(meta)[names(meta) == "Bin"] <- "System_Focus" #More meaningful name
meta_temp = dcast(melt(meta, id.vars = "Sample_ID"), variable ~ Sample_ID)
meta_table <- meta_temp[,-1]
rownames(meta_table) <- meta_temp[,1]
meta_long = t(meta_table)
colnames(meta_temp)[1] = "group"
fullset = full_join(fapro_Long, meta, by="Sample_ID")
fullset[, 2:87] <- sapply(fullset[, 2:87], as.numeric)

#setting order for graphing
fullset$System_Type = as.character(fullset$System_Type)
fullset$System_Type = factor(fullset$System_Type, levels=c("Full scale WRRF", "Scale model WRRF", "Sequencing batch reactor"))

System_Order = c("Full scale WRRF", "Scale model WRRF", "Sequencing batch reactor")
Media_Order = c("Real wastewater", "Synthetic wastewater", "Fermented dairy manure")

# Setting functions known to be associated with waster water
wwt = fullset[,c("aerobic_chemoheterotrophy", "chemoheterotrophy", "denitrification", "nitrate_denitrification", "nitrate_reduction",
"nitrate_respiration",
"nitrite_denitrification",
"nitrite_respiration", "nitrogen_respiration",
"nitrous_oxide_denitrification", "Sample_ID")]
wwt = full_join(wwt, meta, by="Sample_ID")
wwt[, 1:10] <- sapply(wwt[, 1:10], as.numeric)
wwt$group_total <- rowSums(wwt[,1:10])#total number of functions per sample
tot = sum(wwt$group_total)
wwt = transform(wwt, group_percent = group_total/tot)

tot = sum(fullset$group_total)
fullset = transform(fullset, group_percent = group_total/tot)

# Colors used in graphing for consistancy
System_Colors = c("#347F92", "#A6CEE3", "#94DE11")
Media_Colors = c("#F58609", "#A01892", "#F2D000")
```

```{r general overview of system type data}
fullset %>%
  ggplot(aes(x=reorder(Sample_ID, -group_total), y=group_total, fill=System_Focus)) +
         geom_bar(stat="identity") + labs(y="Amount of reads tagged with functionality", x="Sample") + theme_light() + scale_fill_manual(values=c("#52ADC2", "#F58609","purple")) +theme( axis.text.y=element_text(size=10), axis.title=element_text(size=35), title=element_text(size=40), legend.text=element_text(size=25))+
  coord_flip()
ggsave("Functionality_Totals.png", height=11, width=18, dpi=300)

wwt %>%
  ggplot(aes(x=reorder(Sample_ID, -group_total), y=group_total, fill=System_Focus)) +
         geom_bar(stat="identity")+ labs(y="Amount of reads tagged with WWT relevant functionality", x="Sample") + theme_light() + scale_fill_manual(values=c("#52ADC2", "#F58609","purple")) +theme( axis.text.y=element_text(size=10), axis.title=element_text(size=35), title=element_text(size=40), legend.text=element_text(size=25))+
  coord_flip()
ggsave("Functionality_Totals_WWTTarget.png", height=11, width=18, dpi=300)

fullset %>%
  ggplot(aes(x=reorder(System_Focus, -group_total), y=group_total, fill=System_Focus)) +
         geom_bar(stat="identity")+ labs(y="Amount of reads tagged with functionality", x="Sample")+theme_light() + scale_fill_manual(values=c("#52ADC2", "#F58609","purple")) +theme( axis.text.y=element_text(size=25), axis.title=element_text(size=35), title=element_text(size=40), legend.text=element_text(size=25))+
  coord_flip()
ggsave("Functionality_by_system_focus.png", height=11, width=18, dpi=300)

wwt %>%
  ggplot(aes(x=reorder(System_Focus, -group_total), y=group_total, fill=System_Focus)) +
         geom_bar(stat="identity")+ labs(y="Amount of reads tagged with wwt functionality", x="Sample") + theme_light() + scale_fill_manual(values=c("#52ADC2", "#F58609","purple")) + theme( axis.text.y=element_text(size=25), axis.title=element_text(size=35), title=element_text(size=40), legend.text=element_text(size=25))+
  coord_flip()
ggsave("WWT_relivent_functionality_by_system_focus.png", height=11, width=18, dpi=300)

```

```{r relative functionality in top orders }
report$order_relative = report$count/report$order_total

report %>% filter(order %in% c("Bacteroidales", "Burkholderiales", "Chitinophagales", "Cytophagales", "Flavobacteriales", "Rhizobiales", "Rhodobacterales", "Rickettsiales")) %>%
  ggplot(aes(x=order, y=order_relative, fill=functionality)) +
         geom_bar(stat="identity")+ labs(y="Relative abundance of functionality", x="Order")+theme_light() +theme( axis.text.y=element_text(size=15), axis.title=element_text(size=20), title=element_text(size=40), legend.text=element_text(size=15))+
  coord_flip()
ggsave("Functionality_relative_abundance_all_nofilter.png", height=11, width=18, dpi=300)

```

```{r relative functionality in top orders with data correction}
report_filtered = report[-c(2)] 
# The following functions were removed due to overlapping data:

  # [methanol_oxidation] "methanotrophy", "methylotrophy"               # [sulfur_respiration] "respiration_of_sulfur_compounds", "dark_oxidation_of_sulfur_compounds"      
  # [denitrificatoin] "nitrate_denitrification", "nitrite_denitrification", "nitrous_oxide_denitrification", "nitrate_reduction"                    
  # [human_associated] "human_pathogens_all", "human_gut", "mammal_gut", "aromatic_hydrocarbon_degradation"      
  # [nitrate_respiration and nitrogen_fixation] , "nitrogen_respiration",  "nitrite_respiration", "nitrification"
  # [photoautotrophy and photoheterotrophy] "anoxygenic_photoautotrophy_S_oxidizing", "oxygenic_photoautotrophy", "phototrophy", "photosynthetic_cyanobacteria"                        
# For a list of all functions removed run: setdiff(unique(report$functionality), unique(report_filtered$functionality))

# This removes the overlap of aerobic and regular chemeohetertroph so we can have both without overrepresentation
report_filtered = report_filtered %>% filter(functionality %in% c("chemoheterotrophy", "aerobic_chemoheterotrophy")) %>%
   filter(!duplicated(across(-functionality)))

report_filtered = rbind(report_filtered, report[-c(2)] %>% filter(functionality %in% c("denitrification", "	
sulfur_respiration", "thiosulfate_respiration", "iron_respiration", "nitrate_respiration", "dark_sulfide_oxidation", "aerobic_nitrite_oxidation", "aliphatic_non_methane_hydrocarbon_degradation", "animal_parasites_or_symbionts", "anoxygenic_photoautotrophy", "aromatic_compound_degradation", "methanol_oxidation", "cellulolysis", "chitinolysis", "chlorate_reducers", "chloroplasts", "dark_hydrogen_oxidation", "fermentation", "fumarate_respiration", "human_associated", "hydrocarbon_degradation", "intracellular_parasites", "manganese_oxidation", "nitrogen_fixation", "nonphotosynthetic_cyanobacteria", "photoautotrophy", "photoheterotrophy", "predatory_or_exoparasitic", "reductive_acetogenesis", "ureolysis")))

filtered_order_total = aggregate(count~order,report_filtered,sum)
names(filtered_order_total)[2] = 'filtered_order_total'
report_filtered = left_join(report_filtered, filtered_order_total, join_by(order))

report_filtered$order_relative_filtered = report_filtered$count/report_filtered$filtered_order_total

function_bar_order = c("aerobic chemoheterotrophy", "chemoheterotrophy", "fermentation", "denitrification",  "nitrate respiration", "nitrogen fixation", "cellulolysis", "ureolysis", "photoautotrophy", "photoheterotrophy", "animal parasites or symbionts", "chlorate reducers", "manganese oxidation", "hydrocarbon degradation", "aerobic nitrite oxidation", "dark sulfide oxidation", "dark hydrogen oxidation", "anoxygenic photoautotrophy", "iron respiration", "fumarate respiration", "human associated")

report_top_10 = report_filtered %>% filter(order %in% c("Bacteroidales", "Burkholderiales", "Chitinophagales", "Cytophagales", "Flavobacteriales", "Rhizobiales", "Rhodobacterales", "Sphingobacteriales", "Caulobacterales", "Sphingomonadales"))
report_top_10 = report_top_10 %>% mutate(functionality = gsub("_", " ", functionality))
report_top_10$functionality= factor(report_top_10$functionality, levels=function_bar_order)
```

```{r font}
library(extrafont)
library(showtext)
font_add(family = "Skeena Display", regular = "C:/Users/farri/AppData/Local/Microsoft/Windows/Fonts/skeena.ttf")
#font_import()
loadfonts(device = "win", quiet = TRUE)
showtext_auto()
```


```{r plot top 10 orders functionality}
report_top_10 %>% 
  ggplot(aes(x=order, y=order_relative_filtered, fill=functionality)) +
         geom_bar(stat="identity")+ labs(y="Relative abundance of functionality", x="Order")+ggtitle("Functionality in 10 most populous orders")+theme_light() +theme(text=element_text(family="Skeena Display"), plot.background = element_rect(fill = "#F0EEE4"), legend.background = element_rect(fill = "#F0EEE4"), axis.text.y=element_text(size=30), axis.title=element_text(size=35), plot.title = element_text(hjust = 0.5), title=element_text(size=40), legend.text=element_text(size=30),axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+coord_flip()+guides(fill=guide_legend(ncol =1))+
  scale_fill_manual(values = c('#90B30E', '#799900', '#AABA6E', '#D4D700', '#80B918', '#583101', '#7D3600', '#7D451B', '#826046', "#F3722C", '#F8961E','#ffbb33', '#D00000','#9A040F', '#C981B1', '#A35B8B','#7D3565', '#570F3F', '#4A4A4A','#666666', '#8F8F8F', '#B8B8B8','#D9D9D9'))

showtext::showtext_auto()
showtext::showtext_opts(dpi = 300)
ggsave("Functionalities_Top_10_Orders.png", height=11, width=18, dpi=300)
```

```{r data processing: System_Focus by order}
fullset_filtered = fullset[!(row.names(fullset) %in% c("EUBF1","EUBB6","EUBB7", "EUBC7","EUBD1","EUBF5"  ,"EUBC9","EUBB12","EUBG9")),] 
fullset_filtered2 = data.frame(t(fullset_filtered))
colnames(fullset_filtered2) = fullset$Sample_ID

fullset_filtered = fullset_filtered2[-1,]
fullset_filtered = fullset_filtered[-(105:109),]
fullset_filtered = fullset_filtered[-(93:103),]
fullset_filtered2 = data.frame(t(fullset_filtered))
fullset_filtered = as.data.frame(sapply(fullset_filtered2, as.numeric))
fullset_filtered$System_Focus = fullset_filtered2$System_Focus

# Removing overlapping data. When non-overlapping regions can be conserved they are subtracted from parent function. Functions removed by name has no non-overlapping regions.
fullset_filtered$chemoheterotrophy = (fullset_filtered$chemoheterotrophy - fullset_filtered$aerobic_chemoheterotrophy)
fullset_filtered$phototrophy = (fullset_filtered$phototrophy - fullset_filtered$photoheterotrophy)
fullset_filtered$nitrate_reduction = (fullset_filtered$nitrate_reduction - fullset_filtered$nitrate_respiration)
fullset_filtered$photoautotrophy = (fullset_filtered$photoautotrophy - fullset_filtered$oxygenic_photoautotrophy)
fullset_filtered$methylotrophy = (fullset_filtered$methylotrophy - fullset_filtered$methanol_oxidation)
fullset_filtered$animal_parasites_or_symbionts = (fullset_filtered$animal_parasites_or_symbionts - fullset_filtered$human_associated)
fullset_filtered$hydrocarbon_degradation = (fullset_filtered$hydrocarbon_degradation - fullset_filtered$methanotrophy)
fullset_filtered$dark_oxidation_of_sulfur_compounds = (fullset_filtered$dark_oxidation_of_sulfur_compounds - fullset_filtered$dark_sulfide_oxidation)
fullset_filtered = fullset_filtered[ , -which(names(fullset_filtered) %in% c("nitrate_denitrification", "nitrite_denitrification", "nitrous_oxide_denitrification", "photosynthetic_cyanobacteria", "nitrogen_respiration", "human_gut", "mammal_gut", "human_pathogens_all", "aerobic_nitrite_oxidation"))]

System_Focus_PN = fullset_filtered %>% filter(System_Focus == "N and P removal")
System_Focus_PN = t(System_Focus_PN)
temp1 = data.frame(System_Focus_PN[-88,])
System_Focus_PN = as.data.frame(sapply(temp1, as.numeric))
rownames(System_Focus_PN) <- rownames(temp1)
System_Focus_PN$PN = rowSums(System_Focus_PN)
System_Focus_PN=filter(System_Focus_PN, PN > 1500)
System_Focus_PN$functionality = rownames(System_Focus_PN)

System_Focus_P = fullset_filtered %>% filter(System_Focus == "P removal")
System_Focus_P = t(System_Focus_P)
temp2 = data.frame(System_Focus_P[-88,])
System_Focus_P = as.data.frame(sapply(temp2, as.numeric))
rownames(System_Focus_P) = rownames(temp2)
System_Focus_P$P = rowSums(System_Focus_P)
System_Focus_P=filter(System_Focus_P, P > 1500)
System_Focus_P$functionality = rownames(System_Focus_P)

System_Focus_PHA = fullset_filtered %>% filter(System_Focus == "PHA bioplastics reactor")
System_Focus_PHA = t(System_Focus_PHA)
temp3 = data.frame(System_Focus_PHA[-87,])
System_Focus_PHA = as.data.frame(sapply(temp3, as.numeric))
rownames(System_Focus_PHA) = rownames(temp3)
System_Focus_PHA$PHA = rowSums(System_Focus_PHA)
System_Focus_PHA=filter(System_Focus_PHA, PHA > 1500)
System_Focus_PHA$functionality = rownames(System_Focus_PHA)

temp = data.frame(functionality=colnames(fullset_filtered))
np_tot=sum(System_Focus_PN$PN)
p_tot=sum(System_Focus_P$P)
pha_tot=sum(System_Focus_PHA$PHA)

System_Focus_PN=System_Focus_PN[, c("PN", "functionality")]
System_Focus_PN$PN = System_Focus_PN$PN/np_tot
System_Focus_P=System_Focus_P[, c("P", "functionality")]
System_Focus_P$P = System_Focus_P$P/p_tot
System_Focus_PHA=System_Focus_PHA[, c("PHA", "functionality")]
System_Focus_PHA$PHA = System_Focus_PHA$PHA/pha_tot

temp = merge(temp, System_Focus_PN, by="functionality", all=TRUE)
temp = merge(temp, System_Focus_P, by="functionality", all=TRUE)
temp = merge(temp, System_Focus_PHA, by="functionality", all=TRUE)
System_Focuss = pivot_longer(temp, cols = c("PN","P", "PHA"), names_to = "System_Focus", values_to = "count")
System_Focuss = na.omit(System_Focuss)
```

```{r relative abundance by system focus}
function_bar_order = c("aerobic chemoheterotrophy", "chemoheterotrophy", "fermentation", "denitrification",  "nitrate reduction","nitrate respiration", "nitrite respiration", "nitrogen fixation", "ureolysis", "photoheterotrophy",  "chlorate reducers", "manganese oxidation", "methanol oxidation", "dark sulfide oxidation", "dark hydrogen oxidation",  "aromatic compound degradation", "chloroplasts", "phototrophy", "oxygenic photoautotrophy", "nonphotosynthetic cyanobacteria", "human associated", "predatory or exoparasitic", "animal parasites or symbionts","intracellular parasites")
System_Focuss = System_Focuss %>% mutate(functionality = gsub("_", " ", functionality))
System_Focuss$functionality= factor(System_Focuss$functionality, levels=function_bar_order)

System_Focuss %>% mutate(System_Focus = fct_relevel(System_Focus, "PHA", "P","PN")) %>% ggplot(aes(x=System_Focus, y=count, fill=functionality)) +
  geom_bar(stat="identity")+ labs(y="Relative abundance of functionality", x="System")+ggtitle("Functionality in Systems")+theme_light() +theme(text=element_text(family="Skeena Display"), plot.background = element_rect(fill = "#F0EEE4"), legend.background = element_rect(fill = "#F0EEE4"), axis.text.y=element_text(size=30), axis.title=element_text(size=35), plot.title = element_text(hjust = 0.5), title=element_text(size=40), legend.text=element_text(size=30),axis.text.x=element_blank(),axis.ticks.x=element_blank())+coord_flip()+guides(fill=guide_legend(ncol =1))+scale_fill_manual(values = c('#90B30E', '#799900', '#AABA6E', '#D4D700', '#80B918', "#999900", "#555500", '#583101', '#7D3600', '#7D451B', '#826046', '#e95d00',"#F3722C", '#F8961E', '#ffbb33','#D00000','#9d0208','#6a0000','#ff0054', '#ea698b', '#C981B1', '#A35B8B','#7D3565', '#570F3F'))
  
showtext::showtext_auto()
showtext::showtext_opts(dpi = 300)
#
ggsave("Functionalities_by_System_Focus.png", height=10, width=18, dpi=300)
```

```{r plot functionality overview}
fapro5000 %>%
  ggplot(aes(x=reorder(group, -group_total), y=group_total)) +
         geom_bar(stat="identity", fill="#347F92")+ ggtitle("Functionality Seen in >5000 Samples") + labs(y="Amount of Samples Tagged for Specified Functionality", x="Functionality Tag")+theme_light() +theme(axis.text.y=element_text(size=15), axis.title=element_text(size=35), title=element_text(size=40))+
  coord_flip()
ggsave("Functionalities_5000.png", height=10, width=20)

fapro5000 %>%
  ggplot(aes(x=reorder(group, -group_total), y=group_total, fill=group)) +
         geom_bar(stat="identity")+ ggtitle("Functionality for by WWT Relevance") + labs(y="Amount of Samples Tagged for Specified Functionality", x="Functionality Tag")+theme_light()+theme(axis.text.y=element_text(size=15), axis.title=element_text(size=35), title=element_text(size=40), legend.text=element_text(size=20))+
  coord_flip()#+scale_fill_manual(values=c("#347F92","#52ADC2", "#F58609")) 
ggsave("WWT_Functionalities_highlight.png", height=10, width=20)

wwt_fapro %>%
  ggplot(aes(x=reorder(group, -group_total), y=group_total)) +
         geom_bar(stat="identity", fill="#F58609")+ ggtitle("10 Most Common WWT Functional Terms") + labs(y="Amount of Samples Tagged for Specified Functionality", x="Functionality Tag")+theme_light()+theme(axis.text.y=element_text(size=30), axis.title=element_text(size=35), title=element_text(size=40))+
  coord_flip()
ggsave("10_top_WWT_Functionalities.png", height=10, width=20)
```

```{r compairing system type, system focus, and media type}
s = sum(fullset$group_total)
ggplot(fullset, aes(x=System_Type, y=(group_total/s))) +
  geom_col(aes(fill=System_Type), position = 'dodge') + ggtitle("Function vs. System Type") + labs(x="System Type", y="Percentage")+scale_fill_manual(values=System_Colors)

s = sum(wwt$group_total)
ggplot(wwt, aes(x=System_Type, y=(group_total/s))) +
  geom_col(aes(fill=System_Type), position = 'dodge') + ggtitle("WWT Function vs. System Type") + labs(x="System Type", y="Percentage")+scale_fill_manual(values=System_Colors)

ggplot(wwt, aes(x=System_Name, y=(group_total/s))) +
  geom_col(aes(fill=System_Type), position = 'stack') + ggtitle("WWT Function vs. System Name") + labs(x="System Name", y="Percentage") +scale_fill_manual(values=System_Colors)

ggplot(wwt, aes(x=System_Name, y=(group_total/s))) +
  geom_col(aes(fill=Media_Type_1), position = 'dodge') + ggtitle("WWT Function vs. Media Type") + labs(x="Media Type", y="Percentage") +scale_fill_manual(values=Media_Colors)


## Originally these had Parcu in place of System_Focus, but it turned out the way that was generated was giving faulty data. Unsure if graphing parcu in this way would be meaningful due to small dataset.
wwt %>% arrange(Media_Type_1) %>% mutate(Media_Type_1=factor(Media_Type_1, levels=Media_Order)) %>% ggplot(aes(x=System_Focus, y=(group_percent))) +
  geom_col(aes(fill=Media_Type_1), position = 'dodge') + ggtitle("WWT Function") + labs(x="WWT System Type", y="Percentage")+theme_light() +scale_fill_manual(values=c(Media_Colors))

wwt %>% arrange(System_Type) %>% mutate(System_Type=factor(System_Type, levels=System_Order)) %>% ggplot(aes(x=System_Focus, y=group_percent, fill=System_Type)) + geom_col(aes(), position = 'dodge')+ ggtitle("WWT Targeted Functionality") + labs(y="Percent of Functional Tags")+theme_light()+scale_fill_manual(values=System_Colors)
```

```{r plot chemoheterotrophy}
# This can be changed to focus on any column in the dataset, created to zoom in on individual functional tags
fullset$Media_Type_1 = factor(fullset$Media_Type_1, levels = c("Real wastewater", "Synthetic wastewater", "Fermented dairy manure"))

fullset %>% group_by(Collection_Date) %>% ggplot(aes(x=System_Type, y=as.numeric(as.character(chemoheterotrophy)), color=Collection_Date)) +
  geom_point()

fullset %>% ggplot(aes(x=Media_Type_1, y=as.numeric(as.character(chemoheterotrophy)), fill=Media_Type_1)) + geom_col() + scale_fill_manual(values=Media_Colors)
```

```{r data processing: system type}
fullscale = fullset %>% filter(System_Type == "Full scale WRRF")
model = fullset %>% filter(System_Type == "Scale model WRRF")
batch = fullset %>% filter(System_Type == "Sequencing batch reactor")
```

```{r data processing: media type}
realwater = fullset %>% filter(Media_Type_1 == "Real wastewater")
dairywater = fullset %>% filter(Media_Type_1 == "Fermented dairy manure")
synthwater = fullset %>% filter(Media_Type_1 == "Synthetic wastewater")
```

The following sections all focus on functional tags. Ie the 'nitr' section graphs all tags with 'nitr' in them such as nitrate, nitrite, nitrogen_respiration, etc.

```{r subset aerobic}
aerobic_set = dplyr::select(fullset, contains("aerobic"))
aerobic_set$Sample_ID = fullset$Sample_ID
aerobic_set$group_total = rowSums(aerobic_set[,1:4])
aerobic_set = left_join(aerobic_set, meta, by="Sample_ID")

s = sum(fullscale$group_total)
aerobic_set_fullscale = aerobic_set %>% filter(System_Type == "Full scale WRRF") %>% mutate(group_total_percent = group_total/s)

s = sum(model$group_total)
aerobic_set_model = aerobic_set %>% filter(System_Type == "Scale model WRRF") %>% mutate(group_total_percent = group_total/s)

s = sum(batch$group_total)
aerobic_set_batch = aerobic_set %>% filter(System_Type == "Sequencing batch reactor") %>% mutate(group_total_percent = group_total/s)

aerobic_set_percent = rbind(aerobic_set_batch, aerobic_set_model, aerobic_set_fullscale)

ggplot(aerobic_set_percent, aes(x=System_Type, y=group_total_percent, fill=System_Type)) +
  geom_col(aes(), position = 'dodge') + ggtitle("Aerobic- Function vs. System Type") + labs(x="System Type", y="Percentage") + scale_fill_manual(values=System_Colors)
```

```{r subset nitr}

nitr_set = dplyr::select(fullset, contains("nitr"))
nitr_set$Sample_ID = fullset$Sample_ID
nitr_set$group_total = rowSums(nitr_set[,1:13])
nitr_set = left_join(nitr_set, meta, by="Sample_ID")

s = sum(fullscale$group_total)
nitr_set_fullscale = nitr_set %>% filter(System_Type == "Full scale WRRF") %>% mutate(group_total_percent = group_total/s)

s = sum(model$group_total)
nitr_set_model = nitr_set %>% filter(System_Type == "Scale model WRRF") %>% mutate(group_total_percent = group_total/s)

s = sum(batch$group_total)
nitr_set_batch = nitr_set %>% filter(System_Type == "Sequencing batch reactor") %>% mutate(group_total_percent = group_total/s)

nitr_set_percent = rbind(nitr_set_batch, nitr_set_model, nitr_set_fullscale)

ggplot(nitr_set_percent, aes(x=System_Type, y=group_total_percent, fill=System_Type)) +
  geom_col(aes(), position = 'dodge') + ggtitle("Nitr- Function vs. System Type") + labs(x="System Type", y="Percentage") + scale_fill_manual(values=System_Colors)
```

```{r subset ox}

ox_set = dplyr::select(fullset, contains("ox"))
ox_set$Sample_ID = fullset$Sample_ID
ox_set$group_total = rowSums(ox_set[,1:23])
ox_set = left_join(ox_set, meta, by="Sample_ID")

s = sum(fullscale$group_total)
ox_set_fullscale = ox_set %>% filter(System_Type == "Full scale WRRF") %>% mutate(group_total_percent = group_total/s)

s = sum(model$group_total)
ox_set_model = ox_set %>% filter(System_Type == "Scale model WRRF") %>% mutate(group_total_percent = group_total/s)

s = sum(batch$group_total)
ox_set_batch = ox_set %>% filter(System_Type == "Sequencing batch reactor") %>% mutate(group_total_percent = group_total/s)

ox_set_percent = rbind(ox_set_batch, ox_set_model, ox_set_fullscale)

ggplot(ox_set_percent, aes(x=System_Type, y=group_total_percent, fill=System_Type)) +
  geom_col(aes(), position = 'dodge') + ggtitle("Ox- Function vs. System Type") + labs(x="System Type", y="Percentage") + scale_fill_manual(values=System_Colors)

```

```{r subset trophy}

trophy_set = dplyr::select(fullset, contains("trophy"))
trophy_set$Sample_ID = fullset$Sample_ID
trophy_set[,1:13] <- sapply(trophy_set[,1:13], as.numeric)
trophy_set$group_total = rowSums(trophy_set[,1:13])
trophy_set = left_join(trophy_set, meta, by="Sample_ID")

s = sum(fullscale$group_total)
trophy_set_fullscale = trophy_set %>% filter(System_Type == "Full scale WRRF") %>% mutate(group_total_percent = group_total/s)

s = sum(model$group_total)
trophy_set_model = trophy_set %>% filter(System_Type == "Scale model WRRF") %>% mutate(group_total_percent = group_total/s)

s = sum(batch$group_total)
trophy_set_batch = trophy_set %>% filter(System_Type == "Sequencing batch reactor") %>% mutate(group_total_percent = group_total/s)

trophy_set_percent = rbind(trophy_set_batch, trophy_set_model, trophy_set_fullscale)

ggplot(trophy_set_percent, aes(x=System_Type, y=group_total_percent, fill=System_Type)) +
  geom_col(aes(), position = 'dodge') + ggtitle("-trophy Function vs. System Type") + labs(x="System Type", y="Percentage") + scale_fill_manual(values=System_Colors)


```

```{r subset dark}
dark_set = dplyr::select(fullset, contains("dark"))
dark_set$Sample_ID = fullset$Sample_ID
dark_set$group_total = rowSums(dark_set[,1:7])
dark_set = left_join(dark_set, meta, by="Sample_ID")

s = sum(fullscale$group_total)
dark_set_fullscale = dark_set %>% filter(System_Type == "Full scale WRRF") %>% mutate(group_total_percent = group_total/s)

s = sum(model$group_total)
dark_set_model = dark_set %>% filter(System_Type == "Scale model WRRF") %>% mutate(group_total_percent = group_total/s)

s = sum(batch$group_total)
dark_set_batch = dark_set %>% filter(System_Type == "Sequencing batch reactor") %>% mutate(group_total_percent = group_total/s)

dark_set_percent = rbind(dark_set_batch, dark_set_model, dark_set_fullscale)

ggplot(dark_set_percent, aes(x=System_Type, y=group_total_percent, fill=System_Type)) +
  geom_col(aes(), position = 'dodge') + ggtitle("Dark Function vs. System Type") + labs(x="System Type", y="Percentage") + scale_fill_manual(values=System_Colors)

```

```{r subset redu}
redu_set = dplyr::select(fullset, contains("redu"))
redu_set$Sample_ID = fullset$Sample_ID
redu_set[,1:6] <- sapply(redu_set[,1:6], as.numeric)
redu_set$group_total = rowSums(redu_set[,1:6])
redu_set = left_join(redu_set, meta, by="Sample_ID")

s = sum(fullscale$group_total)
redu_set_fullscale = redu_set %>% filter(System_Type == "Full scale WRRF") %>% mutate(group_total_percent = group_total/s)

s = sum(model$group_total)
redu_set_model = redu_set %>% filter(System_Type == "Scale model WRRF") %>% mutate(group_total_percent = group_total/s)

s = sum(batch$group_total)
redu_set_batch = redu_set %>% filter(System_Type == "Sequencing batch reactor") %>% mutate(group_total_percent = group_total/s)

redu_set_percent = rbind(redu_set_batch, redu_set_model, redu_set_fullscale)

ggplot(redu_set_percent, aes(x=System_Type, y=group_total_percent, fill=System_Type)) +
  geom_col(aes(), position = 'dodge') + ggtitle("Redu- Function vs. System Type") + labs(x="System Type", y="Percentage") + scale_fill_manual(values=System_Colors)

```

```{r subset resp}
resp_set = dplyr::select(fullset, contains("resp"))
resp_set$Sample_ID = fullset$Sample_ID
resp_set$group_total = rowSums(resp_set[,1:12])
resp_set = left_join(resp_set, meta, by="Sample_ID")

s = sum(fullscale$group_total)
resp_set_fullscale = resp_set %>% filter(System_Type == "Full scale WRRF") %>% mutate(group_total_percent = group_total/s)

s = sum(model$group_total)
resp_set_model = resp_set %>% filter(System_Type == "Scale model WRRF") %>% mutate(group_total_percent = group_total/s)

s = sum(batch$group_total)
resp_set_batch = resp_set %>% filter(System_Type == "Sequencing batch reactor") %>% mutate(group_total_percent = group_total/s)

resp_set_percent = rbind(resp_set_batch, resp_set_model, resp_set_fullscale)

ggplot(resp_set_percent, aes(x=System_Type, y=group_total_percent, fill=System_Type)) +
  geom_col(aes(), position = 'dodge') + ggtitle("Resp- Function vs. System Type") + labs(x="System Type", y="Percentage") + scale_fill_manual(values=System_Colors)

```